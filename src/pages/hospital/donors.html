<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Donor List - BloodConnect Hospital</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
  </head>

  <body class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div
      class="w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 flex flex-col"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="bg-red-600 p-2 rounded-lg">
            <i data-lucide="heart" class="size-6 text-white fill-white"></i>
          </div>
          <div>
            <div class="font-semibold text-red-600">BloodConnect</div>
            <div class="text-sm text-gray-500">Hospital Portal</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <a
          href="/src/pages/hospital/dashboard.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="layout-dashboard" class="size-5"></i
          ><span>Dashboard</span></a
        >
        <a
          href="/src/pages/hospital/request.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="droplet" class="size-5"></i
          ><span>Request Blood</span></a
        >
        <a
          href="/src/pages/hospital/donors.html"
          class="flex items-center gap-3 px-6 py-3 text-red-600 bg-red-50 border-r-4 border-red-600"
          ><i data-lucide="users" class="size-5"></i><span>Donor List</span></a
        >
        <a
          href="/src/pages/hospital/appointments.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="calendar-check" class="size-5"></i
          ><span>Appointments</span></a
        >
        <a
          href="/src/pages/hospital/chat.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="message-square" class="size-5"></i
          ><span>Chat</span></a
        >
      </nav>
      <div class="p-4 border-t border-gray-200">
        <div class="text-center text-sm text-gray-500">
          <p>Emergency: <span class="text-red-600 font-semibold">911</span></p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="h-16 bg-white border-b border-gray-200 fixed top-0 left-64 right-0 z-10 flex items-center justify-between px-8"
    >
      <div class="flex items-center gap-4 flex-1">
        <h2 class="text-lg font-semibold text-gray-900">Donor List</h2>
      </div>
      <div class="flex items-center gap-4">
        <button class="relative p-2 hover:bg-gray-100 rounded-lg">
          <i data-lucide="bell" class="size-5 text-gray-700"></i>
        </button>
        <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
          <div class="text-right">
            <div class="text-sm font-medium text-gray-900" data-user-name>
              City Hospital
            </div>
            <div class="text-xs text-gray-500" data-user-role>
              Hospital Staff
            </div>
          </div>
          <div
            class="size-10 bg-blue-100 rounded-full flex items-center justify-center"
          >
            <i data-lucide="building-2" class="size-5 text-blue-600"></i>
          </div>
        </div>
        <a href="/" class="p-2 text-gray-600 hover:text-red-600"
          ><i data-lucide="log-out" class="size-5"></i
        ></a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="ml-64 pt-16">
      <!-- Pending Approval Message (Hidden by default) -->
      <div id="pendingApprovalMessage" class="hidden p-8">
        <div class="max-w-2xl mx-auto mt-16">
          <div
            class="p-8 bg-white border border-gray-200 rounded-xl text-center"
          >
            <div
              class="bg-yellow-100 p-4 rounded-full w-20 h-20 mx-auto mb-6 flex items-center justify-center"
            >
              <i data-lucide="clock" class="size-10 text-yellow-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
              Account Under Review
            </h2>
            <p class="text-gray-600 mb-6">
              Your hospital account is currently pending approval. Please wait
              for admin review before you can access the full dashboard and
              create blood requests.
            </p>
            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p class="text-sm text-yellow-800">
                <i data-lucide="info" class="size-4 inline mr-1"></i>This
                usually takes 24-48 hours. You will be notified once your
                account is approved.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Content (Shown when approved) -->
      <div id="dashboardContent" class="p-8 space-y-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">Donor List</h1>
            <p class="text-gray-600">
              Browse and contact registered blood donors
            </p>
          </div>
          <button
            class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
          >
            <i data-lucide="filter" class="size-4 inline mr-2"></i>Filter by
            Location
          </button>
        </div>

        <!-- Quick Filter -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="flex flex-wrap gap-3">
            <button
              class="px-4 py-2 border border-red-600 text-red-600 hover:bg-red-50 rounded-lg font-medium"
            >
              All Donors
            </button>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              O+
            </button>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              O-
            </button>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              A+
            </button>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              A-
            </button>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              B+
            </button>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              B-
            </button>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              AB+
            </button>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              AB-
            </button>
            <div class="flex-1"></div>
            <button
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              Available Only
            </button>
          </div>
        </div>

        <!-- Donors Table -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">
              Registered Donors
            </h2>
            <p class="text-sm text-gray-600" id="donorCountText">
              Total 0 donors in your network
            </p>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-gray-200">
                  <th
                    class="text-left py-3 px-4 text-sm font-medium text-gray-600"
                  >
                    Donor ID
                  </th>
                  <th
                    class="text-left py-3 px-4 text-sm font-medium text-gray-600"
                  >
                    Name
                  </th>
                  <th
                    class="text-left py-3 px-4 text-sm font-medium text-gray-600"
                  >
                    Blood Type
                  </th>
                  <th
                    class="text-left py-3 px-4 text-sm font-medium text-gray-600"
                  >
                    Location
                  </th>
                  <th
                    class="text-left py-3 px-4 text-sm font-medium text-gray-600"
                  >
                    Last Donation
                  </th>
                  <th
                    class="text-left py-3 px-4 text-sm font-medium text-gray-600"
                  >
                    Total
                  </th>
                  <th
                    class="text-left py-3 px-4 text-sm font-medium text-gray-600"
                  >
                    Availability
                  </th>
                  <th
                    class="text-left py-3 px-4 text-sm font-medium text-gray-600"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="donorsTableBody">
                <tr>
                  <td colspan="8" class="py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center gap-2">
                      <i data-lucide="loader-2" class="size-6 animate-spin"></i>
                      <span>Loading donors...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Empty State (hidden by default) -->
          <div id="emptyState" class="hidden text-center py-16 px-6">
            <div
              class="inline-flex items-center justify-center size-20 rounded-full bg-gray-100 mb-4"
            >
              <i data-lucide="droplet" class="size-10 text-gray-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">
              No donors found
            </h3>
            <p id="emptyStateMessage" class="text-gray-600 mb-6">
              No donors match your current filters
            </p>
            <button
              id="clearFiltersBtn"
              class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
            >
              Clear Filters
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Donor Details Modal -->
    <div
      id="donorModal"
      class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center"
    >
      <div class="bg-white rounded-xl max-w-md w-full mx-4 shadow-xl">
        <div
          class="p-6 border-b border-gray-200 flex items-center justify-between"
        >
          <h3
            class="text-lg font-semibold text-gray-900 flex items-center gap-2"
          >
            <i data-lucide="user" class="size-5 text-red-600"></i>
            Donor Details
          </h3>
          <button id="closeModalBtn" class="p-2 hover:bg-gray-100 rounded-lg">
            <i data-lucide="x" class="size-5 text-gray-500"></i>
          </button>
        </div>
        <div class="p-6 space-y-4" id="donorModalContent">
          <!-- Content will be populated dynamically -->
        </div>
        <div class="p-4 border-t border-gray-200 flex justify-end">
          <button
            id="closeModalFooterBtn"
            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <script type="module" src="/src/scripts/main.js"></script>
    <script type="module">
      // Account status check
      async function checkAccountStatus() {
        try {
          const response = await fetch("/api/auth/check.php");
          const data = await response.json();

          if (!data.success || !data.logged_in) {
            window.location.href = "/src/pages/auth/login.html";
            return false;
          }

          const status = data.user.status || "pending";
          const dashboardContent = document.getElementById("dashboardContent");
          const pendingMessage = document.getElementById(
            "pendingApprovalMessage",
          );

          // Handle rejected status - logout and redirect to login
          if (status === "rejected") {
            await fetch("/api/auth/logout.php", { method: "POST" });
            window.location.href = "/src/pages/auth/login.html?error=rejected";
            return false;
          }

          if (status !== "approved") {
            if (dashboardContent) dashboardContent.classList.add("hidden");
            if (pendingMessage) {
              pendingMessage.classList.remove("hidden");
              if (window.lucide) window.lucide.createIcons();
            }
            return false;
          }

          if (dashboardContent) dashboardContent.classList.remove("hidden");
          if (pendingMessage) pendingMessage.classList.add("hidden");
          return true;
        } catch (error) {
          console.error("Failed to check account status:", error);
          return false;
        }
      }

      // Initialize status check
      document.addEventListener("DOMContentLoaded", checkAccountStatus);
    </script>
    <script>
      // Hospital Donor List - Dynamic Data from API
      let donors = [];
      let selectedBloodGroup = "All Donors";
      let availableOnly = false;

      // Show loading state
      function showLoading() {
        const tableBody = document.querySelector("tbody");
        if (tableBody) {
          tableBody.innerHTML = `
          <tr>
            <td colspan="8" class="py-12 text-center">
              <div class="animate-spin size-8 border-4 border-red-600 border-t-transparent rounded-full mx-auto mb-4"></div>
              <p class="text-gray-600">Loading donors...</p>
            </td>
          </tr>
        `;
        }
      }

      // Show error state
      function showError(message) {
        const tableBody = document.querySelector("tbody");
        if (tableBody) {
          tableBody.innerHTML = `
          <tr>
            <td colspan="8" class="py-12 text-center">
              <i data-lucide="alert-circle" class="size-12 text-red-500 mx-auto mb-4"></i>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Donors</h3>
              <p class="text-gray-600">${message}</p>
            </td>
          </tr>
        `;
          lucide.createIcons();
        }
      }

      // Format date for display
      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const date = new Date(dateStr);
        const now = new Date();
        const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return "Today";
        if (diffDays === 1) return "Yesterday";
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30)
          return `${Math.floor(diffDays / 7)} week${
            Math.floor(diffDays / 7) > 1 ? "s" : ""
          } ago`;
        if (diffDays < 365)
          return `${Math.floor(diffDays / 30)} month${
            Math.floor(diffDays / 30) > 1 ? "s" : ""
          } ago`;
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function renderDonors() {
        const tableBody = document.querySelector("tbody");
        const donorCountText = document.querySelector(".text-sm.text-gray-600");
        const emptyState = document.getElementById("emptyState");
        const emptyStateMessage = document.getElementById("emptyStateMessage");

        const filtered = donors.filter((donor) => {
          const matchesBlood =
            selectedBloodGroup === "All Donors" ||
            donor.blood_group === selectedBloodGroup;
          const matchesAvailable = !availableOnly || donor.is_available;
          return matchesBlood && matchesAvailable;
        });

        if (filtered.length === 0) {
          tableBody.parentElement.classList.add("hidden");
          emptyState.classList.remove("hidden");
          emptyStateMessage.textContent =
            selectedBloodGroup !== "All Donors"
              ? `No donors found for ${selectedBloodGroup} blood type`
              : donors.length === 0
                ? "No donors registered in the system yet"
                : "No donors match your current filters";
          donorCountText.textContent = "Total 0 donors in your network";
        } else {
          tableBody.parentElement.classList.remove("hidden");
          emptyState.classList.add("hidden");
          donorCountText.textContent = `Total ${filtered.length} donor${
            filtered.length !== 1 ? "s" : ""
          } ${
            selectedBloodGroup !== "All Donors"
              ? `with ${selectedBloodGroup} blood type `
              : ""
          }in your network`;

          tableBody.innerHTML = filtered
            .map(
              (donor) => `
            <tr class="border-b border-gray-100 hover:bg-gray-50" data-id="${
              donor.id
            }">
              <td class="py-3 px-4 text-gray-900">DON${String(
                donor.id,
              ).padStart(3, "0")}</td>
              <td class="py-3 px-4">
                <div class="flex items-center gap-3">
                  <div class="size-10 bg-red-100 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="size-5 text-red-600"></i>
                  </div>
                  <div>
                    <div class="font-medium text-gray-900">${donor.name}</div>
                    <div class="text-sm text-gray-500">${
                      donor.age || "N/A"
                    } years</div>
                  </div>
                </div>
              </td>
              <td class="py-3 px-4">
                <span class="px-2 py-1 text-xs font-medium border border-red-600 text-red-600 rounded-full">${
                  donor.blood_group || "N/A"
                }</span>
              </td>
              <td class="py-3 px-4 text-gray-600">
                <i data-lucide="map-pin" class="size-4 inline mr-1"></i>${
                  donor.city || "N/A"
                }
              </td>
              <td class="py-3 px-4 text-gray-600">${
                donor.last_donation ? formatDate(donor.last_donation) : "Never"
              }</td>
              <td class="py-3 px-4">
                <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">${
                  donor.total_donations
                } times</span>
              </td>
              <td class="py-3 px-4">
                <span class="px-2 py-1 text-xs font-medium border ${
                  donor.is_available
                    ? "border-green-600 text-green-600"
                    : "border-gray-600 text-gray-600"
                } rounded-full">
                  ${donor.is_available ? "Available" : "Not Available"}
                </span>
              </td>
              <td class="py-3 px-4">
                <div class="flex gap-2">
                  <button class="view-details-btn px-3 py-1 text-sm border border-gray-300 hover:bg-gray-100 rounded-lg" data-id="${
                    donor.id
                  }">
                    <i data-lucide="eye" class="size-4 inline mr-1"></i>View Details
                  </button>
                </div>
              </td>
            </tr>
          `,
            )
            .join("");

          // Re-init lucide icons
          lucide.createIcons();

          // Attach event listeners for View Details buttons
          document.querySelectorAll(".view-details-btn").forEach((btn) => {
            btn.addEventListener("click", function () {
              const donorId = parseInt(this.dataset.id);
              openDonorModal(donorId);
            });
          });
        }
      }

      // Modal functions
      function openDonorModal(donorId) {
        const donor = donors.find((d) => d.id === donorId);
        if (!donor) return;

        const donorModal = document.getElementById("donorModal");
        const donorModalContent = document.getElementById("donorModalContent");

        const availabilityClass = donor.is_available
          ? "border-green-600 text-green-600"
          : "border-gray-600 text-gray-600";

        donorModalContent.innerHTML = `
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            <p class="text-sm text-gray-500">Name</p>
            <p class="font-semibold text-gray-900">${donor.name}</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-500">Age</p>
            <p class="font-semibold text-gray-900">${
              donor.age || "N/A"
            } years</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-500">Blood Type</p>
            <p><span class="px-2 py-1 text-xs font-medium border border-red-600 text-red-600 rounded-full">${
              donor.blood_group || "N/A"
            }</span></p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-500">Availability</p>
            <p><span class="px-2 py-1 text-xs font-medium border ${availabilityClass} rounded-full">${
              donor.is_available ? "Available" : "Not Available"
            }</span></p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-500">Last Donation</p>
            <p class="font-semibold text-gray-900">${
              donor.last_donation ? formatDate(donor.last_donation) : "Never"
            }</p>
          </div>
          <div class="space-y-1">
            <p class="text-sm text-gray-500">Total Donations</p>
            <p class="font-semibold text-gray-900">${
              donor.total_donations
            } times</p>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200 space-y-3">
          <p class="text-sm font-medium text-gray-700">Contact Information</p>
          <div class="flex items-center gap-2 text-gray-600">
            <i data-lucide="phone" class="size-4"></i>
            <span>${donor.phone || "Not available"}</span>
          </div>
          <div class="flex items-center gap-2 text-gray-600">
            <i data-lucide="mail" class="size-4"></i>
            <span>${donor.email || "Not available"}</span>
          </div>
          <div class="flex items-center gap-2 text-gray-600">
            <i data-lucide="map-pin" class="size-4"></i>
            <span>${donor.city || "Not available"}</span>
          </div>
        </div>
      `;

        donorModal.classList.remove("hidden");
        donorModal.classList.add("flex");
        lucide.createIcons();
      }

      function closeDonorModal() {
        const donorModal = document.getElementById("donorModal");
        donorModal.classList.add("hidden");
        donorModal.classList.remove("flex");
      }

      // Fetch donors from API
      async function loadDonors() {
        showLoading();

        try {
          const response = await fetch("/api/hospital/donors.php");

          if (response.status === 401) {
            window.location.href = "/src/pages/auth/login.html";
            return;
          }

          const data = await response.json();

          if (!data.success) {
            showError(data.message || "Failed to load donors.");
            return;
          }

          donors = data.donors || [];
          renderDonors();
        } catch (error) {
          console.error("Error loading donors:", error);
          showError("Unable to connect to the server. Please try again later.");
        }
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        // Modal event listeners
        const donorModal = document.getElementById("donorModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const closeModalFooterBtn = document.getElementById(
          "closeModalFooterBtn",
        );
        const clearFiltersBtn = document.getElementById("clearFiltersBtn");
        const filterContainer = document.querySelector(".flex.flex-wrap.gap-3");
        const filterButtons = filterContainer.querySelectorAll("button");

        closeModalBtn.addEventListener("click", closeDonorModal);
        closeModalFooterBtn.addEventListener("click", closeDonorModal);

        // Close on outside click
        donorModal.addEventListener("click", function (e) {
          if (e.target === donorModal) {
            closeDonorModal();
          }
        });

        // Close on ESC key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && !donorModal.classList.contains("hidden")) {
            closeDonorModal();
          }
        });

        // Set up filter button event listeners
        filterButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            const btnText = btn.textContent.trim();

            if (btnText === "Available Only") {
              availableOnly = !availableOnly;
              btn.classList.toggle("border-green-600", availableOnly);
              btn.classList.toggle("text-green-600", availableOnly);
              btn.classList.toggle("bg-green-50", availableOnly);
              btn.classList.toggle("border-gray-300", !availableOnly);
              btn.classList.toggle("text-gray-700", !availableOnly);
            } else {
              selectedBloodGroup = btnText;
              // Update active state on all blood group buttons
              filterButtons.forEach((b) => {
                const bText = b.textContent.trim();
                if (bText !== "Available Only") {
                  const isActive = bText === selectedBloodGroup;
                  b.classList.toggle("border-red-600", isActive);
                  b.classList.toggle("text-red-600", isActive);
                  b.classList.toggle("bg-red-50", isActive);
                  b.classList.toggle("border-gray-300", !isActive);
                  b.classList.toggle("text-gray-700", !isActive);
                }
              });
            }
            renderDonors();
          });
        });

        // Clear filters button
        clearFiltersBtn.addEventListener("click", function () {
          selectedBloodGroup = "All Donors";
          availableOnly = false;
          filterButtons.forEach((btn) => {
            const btnText = btn.textContent.trim();
            if (btnText === "All Donors") {
              btn.classList.add("border-red-600", "text-red-600");
              btn.classList.remove("border-gray-300", "text-gray-700");
            } else if (btnText === "Available Only") {
              btn.classList.remove(
                "border-green-600",
                "text-green-600",
                "bg-green-50",
              );
              btn.classList.add("border-gray-300", "text-gray-700");
            } else {
              btn.classList.remove(
                "border-red-600",
                "text-red-600",
                "bg-red-50",
              );
              btn.classList.add("border-gray-300", "text-gray-700");
            }
          });
          renderDonors();
        });

        // Load donors from API
        loadDonors();
      });
    </script>
    <script type="module">
      import { initUserLoader } from "/src/scripts/user-loader.js";
      initUserLoader();
    </script>
  </body>
</html>
