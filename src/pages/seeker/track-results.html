<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Track Results - BloodConnect Seeker</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
  </head>

  <body class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div
      class="w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 flex flex-col"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="bg-red-600 p-2 rounded-lg">
            <i data-lucide="heart" class="size-6 text-white fill-white"></i>
          </div>
          <div>
            <div class="font-semibold text-red-600">BloodConnect</div>
            <div class="text-sm text-gray-500">Seeker Portal</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <a
          href="/src/pages/seeker/request.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="send" class="size-5"></i
          ><span>Submit Blood Request</span></a
        >
        <a
          href="/src/pages/seeker/tracking.html"
          class="flex items-center gap-3 px-6 py-3 text-red-600 bg-red-50 border-r-4 border-red-600"
          ><i data-lucide="clipboard-list" class="size-5"></i
          ><span>Track Request</span></a
        >
        <a
          href="/src/pages/seeker/chat.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="message-square" class="size-5"></i
          ><span>Chat with Donor</span></a
        >
      </nav>
      <div class="p-4 border-t border-gray-200">
        <div class="text-center text-sm text-gray-500">
          <p>Emergency: <span class="text-red-600 font-semibold">911</span></p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="h-16 bg-white border-b border-gray-200 fixed top-0 left-64 right-0 z-10 flex items-center justify-between px-8"
    >
      <div class="flex items-center gap-4 flex-1">
        <h2 class="text-lg font-semibold text-gray-900">Tracking Results</h2>
      </div>
      <div class="flex items-center gap-4">
        <button class="relative p-2 hover:bg-gray-100 rounded-lg">
          <i data-lucide="bell" class="size-5 text-gray-700"></i>
        </button>
        <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
          <div class="text-right">
            <div class="text-sm font-medium text-gray-900" data-user-name>
              Guest User
            </div>
            <div class="text-xs text-gray-500" data-user-role>Blood Seeker</div>
          </div>
          <div
            class="size-10 bg-orange-100 rounded-full flex items-center justify-center"
          >
            <i data-lucide="user" class="size-5 text-orange-600"></i>
          </div>
        </div>
        <a href="/" class="p-2 text-gray-600 hover:text-red-600"
          ><i data-lucide="log-out" class="size-5"></i
        ></a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="ml-64 pt-16">
      <div class="p-8 space-y-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 mb-2">
            Tracking Results
          </h1>
          <p class="text-gray-600" id="trackingSubtitle">
            Loading your blood requests...
          </p>
        </div>

        <!-- Results -->
        <div class="space-y-8" id="requestsContainer">
          <!-- Loading state -->
          <div
            class="p-6 bg-white border border-gray-200 rounded-xl text-center py-12"
            id="loadingState"
          >
            <i
              data-lucide="loader"
              class="size-10 text-gray-400 mx-auto mb-4 animate-spin"
            ></i>
            <p class="text-gray-500">Loading your requests...</p>
          </div>
        </div>

        <!-- Empty State -->
        <div
          id="emptyState"
          class="hidden p-6 bg-white border border-gray-200 rounded-xl text-center py-16"
        >
          <div
            class="inline-flex items-center justify-center size-20 rounded-full bg-gray-100 mb-4"
          >
            <i data-lucide="search" class="size-10 text-gray-400"></i>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">
            No Requests Found
          </h3>
          <p class="text-gray-600 mb-6">
            You haven't submitted any blood requests yet.
          </p>
          <a
            href="/src/pages/seeker/request.html"
            class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium"
          >
            <i data-lucide="plus" class="size-4 mr-2"></i>
            Submit a Request
          </a>
        </div>
      </div>
    </main>

    <script type="module" src="/src/scripts/main.js"></script>
    <script type="module">
      import { initUserLoader } from "/src/scripts/user-loader.js";
      initUserLoader();

      const URGENCY_COLORS = {
        emergency: { bg: "bg-red-600", text: "text-white" },
        urgent: { bg: "bg-orange-600", text: "text-white" },
        normal: { bg: "bg-blue-600", text: "text-white" },
      };

      const STATUS_COLORS = {
        pending: {
          bg: "bg-yellow-100",
          text: "text-yellow-800",
          border: "border-yellow-200",
        },
        approved: {
          bg: "bg-blue-100",
          text: "text-blue-800",
          border: "border-blue-200",
        },
        in_progress: {
          bg: "bg-blue-100",
          text: "text-blue-800",
          border: "border-blue-200",
        },
        completed: {
          bg: "bg-green-100",
          text: "text-green-800",
          border: "border-green-200",
        },
        rejected: {
          bg: "bg-red-100",
          text: "text-red-800",
          border: "border-red-200",
        },
        cancelled: {
          bg: "bg-gray-100",
          text: "text-gray-800",
          border: "border-gray-200",
        },
      };

      async function loadRequests() {
        const container = document.getElementById("requestsContainer");
        const loadingState = document.getElementById("loadingState");
        const emptyState = document.getElementById("emptyState");
        const subtitle = document.getElementById("trackingSubtitle");

        try {
          const response = await fetch("/api/seeker/requests.php", {
            credentials: "include",
          });
          const data = await response.json();

          if (loadingState) loadingState.classList.add("hidden");

          if (data.success && data.requests && data.requests.length > 0) {
            subtitle.textContent = `Showing ${
              data.requests.length
            } blood request${data.requests.length !== 1 ? "s" : ""}`;
            container.innerHTML = data.requests
              .map((request) => renderRequestCard(request))
              .join("");
            if (window.lucide) window.lucide.createIcons();
          } else {
            container.classList.add("hidden");
            emptyState.classList.remove("hidden");
            subtitle.textContent = "No requests found";
          }
        } catch (error) {
          console.error("Error loading requests:", error);
          if (loadingState) loadingState.classList.add("hidden");
          container.classList.add("hidden");
          emptyState.classList.remove("hidden");
          subtitle.textContent = "Unable to load requests";
        }
      }

      function renderRequestCard(request) {
        const urgencyColor =
          URGENCY_COLORS[request.urgency] || URGENCY_COLORS["normal"];
        const statusColor =
          STATUS_COLORS[request.status] || STATUS_COLORS["pending"];
        const statusLabel = getStatusLabel(
          request.status,
          request.lifecycle_status
        );

        return `
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="flex items-start justify-between mb-6 pb-6 border-b border-gray-200">
            <div>
              <div class="flex items-center gap-3 mb-2">
                <h2 class="text-lg font-semibold text-gray-900">
                  Request ID: ${request.request_code}
                </h2>
                <span class="px-2 py-1 text-xs font-medium ${urgencyColor.bg} ${
          urgencyColor.text
        } rounded-full capitalize">${request.urgency}</span>
              </div>
              <p class="text-gray-600">
                Patient: ${request.patient_name} • <span class="font-medium">${
          request.blood_type
        }</span> • ${request.quantity} Unit${request.quantity !== 1 ? "s" : ""}
              </p>
            </div>
            <span class="px-3 py-1 text-sm ${statusColor.bg} ${
          statusColor.text
        } border ${statusColor.border} rounded-full">${statusLabel}</span>
          </div>

          <!-- Timeline -->
          ${renderTimeline(request)}

          <div class="flex justify-end">
            <a href="/src/pages/seeker/request-details.html?id=${
              request.request_code
            }"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium flex items-center gap-2">
              <i data-lucide="eye" class="size-4"></i>
              View Full Details
            </a>
          </div>
        </div>
      `;
      }

      function getStatusLabel(status, lifecycleStatus) {
        const labels = {
          pending: "Pending Review",
          approved: "Searching for Donor",
          in_progress: "Donor Matched",
          completed: "Completed",
          rejected: "Rejected",
          cancelled: "Cancelled",
        };
        return lifecycleStatus || labels[status] || status;
      }

      function renderTimeline(request) {
        const stages = [
          { key: "submitted", label: "Submitted", icon: "send" },
          { key: "verified", label: "Verified", icon: "check-circle" },
          { key: "matching", label: "Matching", icon: "clock" },
          { key: "matched", label: "Matched", icon: "user-check" },
          { key: "scheduled", label: "Scheduled", icon: "calendar" },
          { key: "completed", label: "Completed", icon: "package" },
        ];

        const currentStage = getStageFromStatus(
          request.status,
          request.donation
        );

        return `
        <div class="flex items-center justify-between mb-6">
          ${stages
            .map((stage, index) => {
              const isCompleted = index < currentStage;
              const isCurrent = index === currentStage;
              const isPending = index > currentStage;

              const bgColor = isCompleted
                ? "bg-green-100"
                : isCurrent
                ? "bg-blue-100"
                : "bg-gray-100";
              const iconColor = isCompleted
                ? "text-green-600"
                : isCurrent
                ? "text-blue-600"
                : "text-gray-400";
              const textColor = isCompleted
                ? "text-green-600"
                : isCurrent
                ? "text-blue-600 font-medium"
                : "text-gray-400";
              const lineColor = isCompleted ? "bg-green-200" : "bg-gray-200";

              return `
              ${
                index > 0
                  ? `<div class="flex-1 h-1 ${lineColor} mx-2"></div>`
                  : ""
              }
              <div class="flex items-center gap-2">
                <div class="size-8 rounded-full ${bgColor} flex items-center justify-center">
                  <i data-lucide="${
                    stage.icon
                  }" class="size-4 ${iconColor}"></i>
                </div>
                <span class="text-sm ${textColor}">${stage.label}</span>
              </div>
            `;
            })
            .join("")}
        </div>
      `;
      }

      function getStageFromStatus(status, donation) {
        if (status === "completed") return 5;
        if (status === "rejected" || status === "cancelled") return 0;
        if (donation) {
          if (donation.status === "completed") return 5;
          if (donation.completed_at) return 5;
          if (donation.reached_at) return 4;
          if (donation.started_at) return 4;
          if (donation.accepted_at) return 3;
          return 2;
        }
        if (status === "approved" || status === "in_progress") return 2;
        if (status === "pending") return 1;
        return 0;
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", loadRequests);
    </script>
  </body>
</html>
