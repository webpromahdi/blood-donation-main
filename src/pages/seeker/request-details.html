<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Request Details - BloodConnect Seeker</title>
  <link rel="stylesheet" href="/src/styles/styles.css" />
</head>

<body class="min-h-screen bg-gray-50">
  <!-- Sidebar -->
  <div class="w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 flex flex-col">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center gap-3">
        <div class="bg-red-600 p-2 rounded-lg">
          <i data-lucide="heart" class="size-6 text-white fill-white"></i>
        </div>
        <div>
          <div class="font-semibold text-red-600">BloodConnect</div>
          <div class="text-sm text-gray-500">Seeker Portal</div>
        </div>
      </div>
    </div>
    <nav class="flex-1 overflow-y-auto py-4">
      <a href="/src/pages/seeker/request.html"
        class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"><i data-lucide="send"
          class="size-5"></i><span>Submit Blood Request</span></a>
      <a href="/src/pages/seeker/tracking.html"
        class="flex items-center gap-3 px-6 py-3 text-red-600 bg-red-50 border-r-4 border-red-600"><i
          data-lucide="clipboard-list" class="size-5"></i><span>Track Request</span></a>
      <a href="/src/pages/seeker/chat.html"
        class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"><i
          data-lucide="message-square" class="size-5"></i><span>Chat with Donor</span></a>
    </nav>
    <div class="p-4 border-t border-gray-200">
      <div class="text-center text-sm text-gray-500">
        <p>Emergency: <span class="text-red-600 font-semibold">911</span></p>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header
    class="h-16 bg-white border-b border-gray-200 fixed top-0 left-64 right-0 z-10 flex items-center justify-between px-8">
    <div class="flex items-center gap-4 flex-1">
      <h2 class="text-lg font-semibold text-gray-900">Request Details</h2>
    </div>
    <div class="flex items-center gap-4">
      <!-- Notification Dropdown -->
      <div class="relative" id="notificationDropdown">
        <button class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="toggleNotifications()">
          <i data-lucide="bell" class="size-5 text-gray-700"></i>
          <span
            class="absolute -top-1 -right-1 size-5 flex items-center justify-center bg-red-600 text-white text-xs rounded-full"
            id="notificationBadge">2</span>
        </button>
        <!-- Notification Panel -->
        <div id="notificationPanel"
          class="hidden absolute right-0 top-12 w-80 bg-white border border-gray-200 rounded-xl shadow-xl z-50">
          <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="font-semibold text-gray-900">Notifications</h3>
            <button onclick="markAllAsRead()" class="text-xs text-red-600 hover:text-red-700 font-medium">
              Mark all as read
            </button>
          </div>
          <div class="max-h-80 overflow-y-auto" id="notificationList"></div>
          <div class="p-3 border-t border-gray-200 text-center">
            <button class="text-sm text-red-600 hover:text-red-700 font-medium">
              View all
            </button>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
        <div class="text-right">
          <div class="text-sm font-medium text-gray-900" data-user-name>
            Guest User
          </div>
          <div class="text-xs text-gray-500" data-user-role>Blood Seeker</div>
        </div>
        <div class="size-10 bg-orange-100 rounded-full flex items-center justify-center">
          <i data-lucide="user" class="size-5 text-orange-600"></i>
        </div>
      </div>
      <a href="/" class="p-2 text-gray-600 hover:text-red-600"><i data-lucide="log-out" class="size-5"></i></a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="ml-64 pt-16">
    <div class="p-8 space-y-8">
      <div class="flex items-center gap-4">
        <a href="/src/pages/seeker/tracking.html" class="p-2 hover:bg-gray-100 rounded-lg"><i data-lucide="arrow-left"
            class="size-5 text-gray-600"></i></a>
        <div>
          <h1 class="text-2xl font-bold text-gray-900 mb-1">
            Request ID: Loading...
          </h1>
          <p class="text-gray-600">Submitted on --</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Request Info Card -->
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <div class="flex items-start justify-between mb-6 pb-6 border-b border-gray-200">
              <div>
                <div class="flex items-center gap-3 mb-2">
                  <h2 class="text-lg font-semibold text-gray-900">
                    Request Information
                  </h2>
                  <span class="px-2 py-1 text-xs font-medium bg-red-600 text-white rounded-full">Emergency</span>
                </div>
                <p class="text-gray-600">
                  Detailed view of your blood request
                </p>
              </div>
              <div class="flex items-center gap-2">
                <i data-lucide="droplet" class="size-8 text-red-600 fill-red-600"></i>
                <span class="text-2xl font-bold text-red-600">O+</span>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
              <div>
                <p class="text-sm text-gray-500 mb-1">Patient Name</p>
                <p class="font-medium text-gray-900">Loading...</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 mb-1">Patient Age</p>
                <p class="font-medium text-gray-900">--</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 mb-1">Quantity Needed</p>
                <p class="font-medium text-gray-900">--</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 mb-1">Required By</p>
                <p class="font-medium text-gray-900">--</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 mb-1">Hospital</p>
                <p class="font-medium text-gray-900">--</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 mb-1">Hospital Address</p>
                <p class="font-medium text-gray-900">--</p>
              </div>
              <div class="col-span-2">
                <p class="text-sm text-gray-500 mb-1">Medical Reason</p>
                <p class="font-medium text-gray-900">--</p>
              </div>
            </div>
          </div>

          <!-- Assigned Donor -->
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <i data-lucide="user-check" class="size-5 text-green-600"></i>
                Assigned Donor
              </h2>
              <span class="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-full flex items-center gap-1">
                <i data-lucide="navigation" class="size-3"></i>
                On the Way
              </span>
            </div>

            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-5">
              <div class="flex items-start gap-4">
                <!-- Donor Avatar -->
                <div class="size-16 bg-green-100 rounded-full flex items-center justify-center shrink-0">
                  <i data-lucide="user" class="size-8 text-green-600"></i>
                </div>

                <!-- Donor Info -->
                <div class="flex-1">
                  <h3 id="donorName" class="text-lg font-semibold text-gray-900 mb-2">
                    --
                  </h3>
                  <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex items-center gap-2">
                      <i data-lucide="droplet" class="size-4 text-red-600"></i>
                      <span class="text-gray-600">Blood Type:</span>
                      <span id="donorBloodTypeInfo" class="font-bold text-red-600">--</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i data-lucide="map-pin" class="size-4 text-gray-500"></i>
                      <span class="text-gray-600">Location:</span>
                      <span id="donorLocation" class="font-medium text-gray-900">--</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i data-lucide="clock" class="size-4 text-gray-500"></i>
                      <span class="text-gray-600">Accepted:</span>
                      <span id="donorAcceptedTime" class="font-medium text-gray-900">--</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i data-lucide="star" class="size-4 text-yellow-500"></i>
                      <span class="text-gray-600">Donations:</span>
                      <span id="donorTotalDonations" class="font-medium text-gray-900">--</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Status Message -->
              <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center gap-2 text-blue-700">
                  <i data-lucide="navigation" class="size-4"></i>
                  <span class="text-sm font-medium">Donor is on the way to City Hospital</span>
                </div>
                <p class="text-xs text-blue-600 mt-1 ml-6">
                  Estimated arrival: ~15 minutes
                </p>
              </div>

              <!-- Action Buttons -->
              <div class="mt-5 pt-4 border-t border-green-200">
                <div class="flex gap-3">
                  <button id="viewDonorDetailsBtn"
                    class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                    <i data-lucide="file-text" class="size-5"></i>
                    View Details
                  </button>
                  <a href="/src/pages/seeker/chat.html"
                    class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                    <i data-lucide="message-square" class="size-5"></i>
                    Chat with Donor
                  </a>
                </div>
                <p class="text-xs text-gray-500 text-center mt-2">
                  View donor health info or communicate about arrival
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Donor Health Details Modal -->
        <div id="donorDetailsModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div
              class="p-6 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-2xl">
              <div class="flex items-center gap-3">
                <div class="size-12 bg-green-100 rounded-full flex items-center justify-center">
                  <i data-lucide="user" class="size-6 text-green-600"></i>
                </div>
                <div>
                  <h3 id="donorNameContact" class="text-lg font-semibold text-gray-900">
                    --
                  </h3>
                  <div class="flex items-center gap-2 text-sm">
                    <span class="flex items-center gap-1 text-red-600 font-medium">
                      <i data-lucide="droplet" class="size-3"></i><span id="donorBloodType">--</span>
                    </span>
                    <span class="text-gray-400">â€¢</span>
                    <span id="donorDonations" class="text-gray-600">-- Donations</span>
                  </div>
                </div>
              </div>
              <button id="closeModalBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <i data-lucide="x" class="size-5 text-gray-500"></i>
              </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
              <!-- Loading State -->
              <div id="donorModalLoading" class="text-center py-8">
                <div class="animate-spin size-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-3"></div>
                <p class="text-gray-500">Loading donor health information...</p>
              </div>
              
              <!-- Content (hidden by default, shown when data loads) -->
              <div id="donorModalContent" class="hidden">
                <!-- Eligibility Status -->
                <div id="eligibilityStatus" class="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg mb-6">
                  <div class="flex items-center gap-3">
                    <i data-lucide="check-circle" class="size-6 text-green-600"></i>
                    <span class="font-medium text-gray-900">Donation Eligibility</span>
                  </div>
                  <span id="eligibilityBadge" class="px-3 py-1 text-sm font-medium bg-green-100 text-green-700 rounded-full">Eligible</span>
                </div>

                <!-- Health Metrics -->
                <div class="mb-6">
                  <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i data-lucide="activity" class="size-4 text-blue-600"></i>
                    Health Metrics
                  </h4>
                  <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-gray-50 rounded-lg">
                      <p class="text-xs text-gray-500 mb-1">Weight</p>
                      <p id="modalWeight" class="font-semibold text-gray-900">--</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                      <p class="text-xs text-gray-500 mb-1">Height</p>
                      <p id="modalHeight" class="font-semibold text-gray-900">--</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                      <p class="text-xs text-gray-500 mb-1">Blood Pressure</p>
                      <p id="modalBloodPressure" class="font-semibold text-gray-900">--</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                      <p class="text-xs text-gray-500 mb-1">Hemoglobin</p>
                      <p id="modalHemoglobin" class="font-semibold text-gray-900">--</p>
                    </div>
                  </div>
                </div>

                <!-- Medical Conditions -->
                <div class="mb-6">
                  <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i data-lucide="clipboard-list" class="size-4 text-purple-600"></i>
                    Medical Conditions
                  </h4>
                  <div id="modalConditions" class="flex flex-wrap gap-2">
                    <!-- Will be populated dynamically -->
                  </div>
                </div>

                <!-- Lifestyle -->
                <div class="mb-6">
                  <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i data-lucide="heart" class="size-4 text-red-500"></i>
                    Lifestyle
                  </h4>
                  <div class="space-y-2">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <span class="text-sm text-gray-600">Smoking</span>
                      <span id="modalSmoking" class="text-sm font-medium text-green-600">--</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <span class="text-sm text-gray-600">Alcohol</span>
                      <span id="modalAlcohol" class="text-sm font-medium text-gray-900">--</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <span class="text-sm text-gray-600">Exercise</span>
                      <span id="modalExercise" class="text-sm font-medium text-gray-900">--</span>
                    </div>
                  </div>
                </div>

                <!-- Last Checkup -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                  <div class="flex items-center gap-3">
                    <i data-lucide="calendar-check" class="size-5 text-blue-600"></i>
                    <div>
                      <p class="text-xs text-blue-600">Last Medical Checkup</p>
                      <p id="modalLastCheckup" class="font-medium text-gray-900">--</p>
                    </div>
                </div>
              </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
              <button id="closeModalBtn2"
                class="w-full py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                Close
              </button>
            </div>
          </div>
        </div>

        <!-- Side Panel -->
        <div class="space-y-6">
          <!-- Contact Info -->
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <h3 class="font-semibold text-gray-900 mb-4">
              Contact Information
            </h3>
            <div class="space-y-4">
              <div class="flex items-center gap-3">
                <div class="bg-gray-100 p-2 rounded-lg">
                  <i data-lucide="phone" class="size-5 text-gray-600"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Phone</p>
                  <p id="contactPhone" class="font-medium text-gray-900">
                    --
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="bg-gray-100 p-2 rounded-lg">
                  <i data-lucide="mail" class="size-5 text-gray-600"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Email</p>
                  <p id="contactEmail" class="font-medium text-gray-900">
                    --
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Appointment Info -->
          <div id="appointmentSection" class="p-6 bg-green-50 border border-green-200 rounded-xl">
            <div class="flex items-center gap-2 mb-4">
              <i data-lucide="calendar" class="size-5 text-green-600"></i>
              <h3 class="font-semibold text-gray-900">
                Scheduled Appointment
              </h3>
            </div>
            <div class="space-y-3">
              <div>
                <p class="text-sm text-gray-600">Date</p>
                <p id="appointmentDate" class="font-medium text-gray-900">
                  --
                </p>
              </div>
              <div>
                <p class="text-sm text-gray-600">Time</p>
                <p id="appointmentTime" class="font-medium text-gray-900">
                  --
                </p>
              </div>
              <div>
                <p class="text-sm text-gray-600">Donor</p>
                <p id="appointmentDonor" class="font-medium text-gray-900">
                  --
                </p>
              </div>
              <div>
                <p class="text-sm text-gray-600">Location</p>
                <p id="appointmentLocation" class="font-medium text-gray-900">
                  --
                </p>
              </div>
            </div>
          </div>

          <!-- Hospital Contact -->
          <div class="p-6 bg-white border border-gray-200 rounded-xl border-l-4 border-l-blue-600">
            <div class="flex items-start gap-3">
              <i data-lucide="building-2" class="size-6 text-blue-600 shrink-0 mt-1"></i>
              <div>
                <h3 id="hospitalName" class="font-semibold text-gray-900 mb-2">
                  --
                </h3>
                <p id="hospitalAddress" class="text-sm text-gray-600 mb-2">
                  --
                </p>
                <p id="hospitalPhone" class="text-blue-600 font-medium">--</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module" src="/src/scripts/main.js"></script>
  <script type="module" src="/src/scripts/pages/seeker.js"></script>
  <script type="module">
    import { initNotificationDropdown } from "/src/scripts/components/notification-dropdown.js";
    initNotificationDropdown("seeker");
  </script>
  <script type="module">
    import { initUserLoader } from "/src/scripts/user-loader.js";
    initUserLoader();
  </script>
  <script>
    // Store request data globally for modal access
    let currentRequestData = null;
    
    // Function to fetch and display donor health details
    async function fetchDonorHealthDetails(requestId) {
      const modal = document.getElementById('donorDetailsModal');
      const loadingEl = document.getElementById('donorModalLoading');
      const contentEl = document.getElementById('donorModalContent');
      
      // Show modal with loading state
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (loadingEl) loadingEl.classList.remove('hidden');
      if (contentEl) contentEl.classList.add('hidden');
      
      try {
        const response = await fetch(`/api/donor/health/details.php?request_id=${requestId}`, {
          credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
          // Populate modal with real data
          const donor = data.donor;
          const health = data.health;
          
          // Header info
          document.getElementById('donorNameContact').textContent = donor.name || 'Donor';
          document.getElementById('donorBloodType').textContent = donor.blood_group || 'N/A';
          document.getElementById('donorDonations').textContent = `${donor.total_donations || 0} Donations`;
          
          // Eligibility
          const eligibilityEl = document.getElementById('eligibilityStatus');
          const eligibilityBadge = document.getElementById('eligibilityBadge');
          if (health.is_eligible) {
            eligibilityEl.className = 'flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg mb-6';
            eligibilityBadge.textContent = 'Eligible';
            eligibilityBadge.className = 'px-3 py-1 text-sm font-medium bg-green-100 text-green-700 rounded-full';
          } else {
            eligibilityEl.className = 'flex items-center justify-between p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-6';
            eligibilityBadge.textContent = 'Requires Review';
            eligibilityBadge.className = 'px-3 py-1 text-sm font-medium bg-yellow-100 text-yellow-700 rounded-full';
          }
          
          // Health metrics
          document.getElementById('modalWeight').textContent = health.weight ? `${health.weight} kg` : 'Not provided';
          document.getElementById('modalHeight').textContent = health.height ? `${health.height} cm` : 'Not provided';
          document.getElementById('modalBloodPressure').textContent = health.blood_pressure || 'Not provided';
          document.getElementById('modalHemoglobin').textContent = health.hemoglobin || 'Not provided';
          
          // Conditions
          const conditionsEl = document.getElementById('modalConditions');
          const conditions = health.conditions || {};
          conditionsEl.innerHTML = Object.entries({
            'Diabetes': conditions.diabetes,
            'Hypertension': conditions.hypertension,
            'Heart Disease': conditions.heart_disease,
            'Allergies': conditions.allergies
          }).map(([name, isGood]) => `
            <span class="px-3 py-1 text-sm ${isGood ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} rounded-full flex items-center gap-1">
              <i data-lucide="${isGood ? 'check' : 'x'}" class="size-3"></i> ${isGood ? 'No ' : ''}${name}
            </span>
          `).join('');
          
          // Lifestyle
          const lifestyle = health.lifestyle || {};
          document.getElementById('modalSmoking').textContent = lifestyle.smoking || 'Not specified';
          document.getElementById('modalSmoking').className = lifestyle.smoking === 'No' ? 'text-sm font-medium text-green-600' : 'text-sm font-medium text-gray-900';
          document.getElementById('modalAlcohol').textContent = lifestyle.alcohol || 'Not specified';
          document.getElementById('modalExercise').textContent = lifestyle.exercise || 'Not specified';
          
          // Last checkup
          document.getElementById('modalLastCheckup').textContent = health.last_checkup 
            ? new Date(health.last_checkup).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
            : 'Not provided';
          
          // Show content, hide loading
          if (loadingEl) loadingEl.classList.add('hidden');
          if (contentEl) contentEl.classList.remove('hidden');
          
          // Refresh icons
          if (window.lucide) lucide.createIcons();
        } else {
          throw new Error(data.message || 'Failed to load donor details');
        }
      } catch (error) {
        console.error('Error fetching donor health:', error);
        if (loadingEl) {
          loadingEl.innerHTML = `
            <div class="text-center py-8">
              <i data-lucide="alert-circle" class="size-12 text-red-500 mx-auto mb-3"></i>
              <p class="text-gray-700 font-medium">Unable to load donor details</p>
              <p class="text-gray-500 text-sm mt-1">${error.message}</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
        }
      }
    }
    
    // Modal close handlers
    function closeModal() {
      const modal = document.getElementById('donorDetailsModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    document.getElementById('closeModalBtn')?.addEventListener('click', closeModal);
    document.getElementById('closeModalBtn2')?.addEventListener('click', closeModal);
    
    // Close on backdrop click
    document.getElementById('donorDetailsModal')?.addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
    
    // Status configurations for display
    const statusConfig = {
      rejected: {
        showDonor: false,
        showAppointment: false,
        message: "This request was rejected by admin.",
        messageClass: "bg-red-50 border-red-200 text-red-700",
      },
      pending: {
        showDonor: false,
        showAppointment: false,
        message: "Your request is being reviewed by admin.",
        messageClass: "bg-yellow-50 border-yellow-200 text-yellow-700",
      },
      approved: {
        showDonor: false,
        showAppointment: false,
        message:
          "Your request has been approved. Searching for compatible donors.",
        messageClass: "bg-blue-50 border-blue-200 text-blue-700",
      },
      donor_assigned: {
        showDonor: true,
        showAppointment: true,
        donorStatus: "Accepted",
        message: "A donor has accepted your request.",
        messageClass: "bg-indigo-50 border-indigo-200 text-indigo-700",
      },
      on_the_way: {
        showDonor: true,
        showAppointment: true,
        donorStatus: "On the Way",
        message: "Donor is on the way to the hospital.",
        messageClass: "bg-purple-50 border-purple-200 text-purple-700",
      },
      reached: {
        showDonor: true,
        showAppointment: true,
        donorStatus: "Reached",
        message: "Donor has arrived at the hospital.",
        messageClass: "bg-teal-50 border-teal-200 text-teal-700",
      },
      completed: {
        showDonor: true,
        showAppointment: false,
        donorStatus: "Completed",
        message: "Donation completed successfully!",
        messageClass: "bg-green-50 border-green-200 text-green-700",
      },
    };

    // Show loading state
    function showLoading() {
      const mainContent = document.querySelector(".lg\\:col-span-2");
      if (mainContent) {
        mainContent.innerHTML = `
          <div class="p-12 bg-white border border-gray-200 rounded-xl text-center">
            <div class="animate-spin size-12 border-4 border-red-600 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600">Loading request details...</p>
          </div>
        `;
      }
    }

    // Show error state
    function showError(message) {
      const mainContent = document.querySelector(".lg\\:col-span-2");
      if (mainContent) {
        mainContent.innerHTML = `
          <div class="p-12 bg-white border border-red-200 rounded-xl text-center">
            <i data-lucide="alert-circle" class="size-12 text-red-500 mx-auto mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Request</h3>
            <p class="text-gray-600 mb-4">${message}</p>
            <a href="/src/pages/seeker/tracking.html" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
              <i data-lucide="arrow-left" class="size-4"></i>
              Back to Tracking
            </a>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Format date for display
    function formatDate(dateStr) {
      if (!dateStr) return "N/A";
      const date = new Date(dateStr);
      return date.toLocaleString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      });
    }

    // Render request details
    function renderRequest(request) {
      const lifecycleStatus = request.lifecycle_status || request.status;
      const config = statusConfig[lifecycleStatus] || statusConfig["pending"];

      // Update page header
      const titleEl = document.querySelector("h1.text-2xl");
      if (titleEl) {
        titleEl.innerHTML = `Request ID: ${request.request_code}`;
      }

      const submittedEl = document.querySelector("h1.text-2xl + p");
      if (submittedEl) {
        submittedEl.textContent = `Submitted on ${formatDate(
          request.created_at
        )}`;
      }

      // Update request info section
      const patientNameEl = document.querySelector(
        ".grid.grid-cols-2.gap-6 > div:nth-child(1) p.font-medium"
      );
      if (patientNameEl)
        patientNameEl.textContent = request.patient_name || "N/A";

      const patientAgeEl = document.querySelector(
        ".grid.grid-cols-2.gap-6 > div:nth-child(2) p.font-medium"
      );
      if (patientAgeEl)
        patientAgeEl.textContent = request.patient_age
          ? `${request.patient_age} years`
          : "N/A";

      const bloodTypeEls = document.querySelectorAll(
        ".text-2xl.font-bold.text-red-600"
      );
      bloodTypeEls.forEach(
        (el) => (el.textContent = request.blood_type || "N/A")
      );

      const quantityEl = document.querySelector(
        ".grid.grid-cols-2.gap-6 > div:nth-child(3) p.font-medium"
      );
      if (quantityEl)
        quantityEl.textContent = `${request.quantity || 1} Unit${request.quantity !== 1 ? "s" : ""
          }`;

      const requiredByEl = document.querySelector(
        ".grid.grid-cols-2.gap-6 > div:nth-child(4) p.font-medium"
      );
      if (requiredByEl)
        requiredByEl.textContent = request.required_date || "N/A";

      const hospitalEl = document.querySelector(
        ".grid.grid-cols-2.gap-6 > div:nth-child(5) p.font-medium"
      );
      if (hospitalEl) hospitalEl.textContent = request.hospital_name || "N/A";

      const addressEl = document.querySelector(
        ".grid.grid-cols-2.gap-6 > div:nth-child(6) p.font-medium"
      );
      if (addressEl) addressEl.textContent = request.city || "N/A";

      const reasonEl = document.querySelector(
        ".grid.grid-cols-2.gap-6 .col-span-2 p.font-medium"
      );
      if (reasonEl)
        reasonEl.textContent = request.medical_reason || "Not specified";

      // Update urgency badge
      const urgencyBadge = document.querySelector(
        "span.px-2.py-1.text-xs.font-medium.bg-red-600, span.px-2.py-1.text-xs.font-medium.bg-blue-600"
      );
      if (urgencyBadge) {
        const isEmergency = request.urgency === "emergency";
        urgencyBadge.textContent = isEmergency ? "Emergency" : "Normal";
        urgencyBadge.className = `px-2 py-1 text-xs font-medium ${isEmergency ? "bg-red-600" : "bg-blue-600"
          } text-white rounded-full`;
      }

      // Get donor section
      const donorSection = document.querySelector(
        ".lg\\:col-span-2 .p-6.bg-white.border.border-gray-200.rounded-xl:nth-child(2)"
      );
      const appointmentSection = document.querySelector(
        ".p-6.bg-green-50.border.border-green-200.rounded-xl"
      );

      // Handle donor section based on status
      if (!config.showDonor && donorSection) {
        donorSection.innerHTML = `
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <i data-lucide="info" class="size-5 text-gray-500"></i>
              Request Status
            </h2>
          </div>
          <div class="p-6 ${config.messageClass} border rounded-xl">
            <div class="flex items-center gap-3">
              <i data-lucide="${lifecycleStatus === "rejected" ? "x-circle" : "clock"
          }" class="size-8 ${lifecycleStatus === "rejected" ? "text-red-500" : "text-gray-500"
          }"></i>
              <div>
                <p class="font-semibold text-lg">${config.message}</p>
                ${lifecycleStatus === "rejected" && request.rejection_reason
            ? `<p class="text-sm mt-1 opacity-80">Reason: ${request.rejection_reason}</p>`
            : ""
          }
                ${lifecycleStatus === "rejected"
            ? '<p class="text-sm mt-1 opacity-80">Please contact support for more information or submit a new request.</p>'
            : ""
          }
                ${lifecycleStatus === "approved"
            ? '<p class="text-sm mt-1 opacity-80">Compatible donors in your area are being notified.</p>'
            : ""
          }
              </div>
            </div>
          </div>
        `;
        lucide.createIcons();
      } else if (config.showDonor && request.donation && donorSection) {
        // Update with real donor info
        const donor = request.donation;
        donorSection.innerHTML = `
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <i data-lucide="user-check" class="size-5 text-green-600"></i>
              Assigned Donor
            </h2>
            <span class="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-full flex items-center gap-1">
              <i data-lucide="navigation" class="size-3"></i>
              ${config.donorStatus}
            </span>
          </div>
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-5">
            <div class="flex items-start gap-4">
              <div class="size-16 bg-green-100 rounded-full flex items-center justify-center shrink-0">
                <i data-lucide="user" class="size-8 text-green-600"></i>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">${donor.donor_name || "Donor"
          }</h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                  <div class="flex items-center gap-2">
                    <i data-lucide="droplet" class="size-4 text-red-600"></i>
                    <span class="text-gray-600">Blood Type:</span>
                    <span class="font-bold text-red-600">${donor.donor_blood_group || request.blood_type
          }</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <i data-lucide="map-pin" class="size-4 text-gray-500"></i>
                    <span class="text-gray-600">Location:</span>
                    <span class="font-medium text-gray-900">${donor.donor_city || "N/A"
          }</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <i data-lucide="clock" class="size-4 text-gray-500"></i>
                    <span class="text-gray-600">Accepted:</span>
                    <span class="font-medium text-gray-900">${donor.accepted_at ? formatDate(donor.accepted_at) : "N/A"
          }</span>
                  </div>
                  ${donor.donor_phone
            ? `
                  <div class="flex items-center gap-2">
                    <i data-lucide="phone" class="size-4 text-gray-500"></i>
                    <span class="text-gray-600">Phone:</span>
                    <span class="font-medium text-gray-900">${donor.donor_phone}</span>
                  </div>
                  `
            : ""
          }
                </div>
              </div>
            </div>
            <div class="mt-4 p-3 ${config.messageClass} border rounded-lg">
              <div class="flex items-center gap-2">
                <i data-lucide="navigation" class="size-4"></i>
                <span class="text-sm font-medium">${config.message}</span>
              </div>
            </div>
            <div class="mt-5 pt-4 border-t border-green-200">
              <div class="flex gap-3">
                <button id="viewDonorDetailsBtn" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                  <i data-lucide="file-text" class="size-5"></i>
                  View Details
                </button>
                <a href="/src/pages/seeker/chat.html" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                  <i data-lucide="message-square" class="size-5"></i>
                  Chat with Donor
                </a>
              </div>
            </div>
          </div>
        `;
        lucide.createIcons();

        // Store request data for modal
        currentRequestData = request;

        // Bind click handler for View Details button
        const viewBtn = document.getElementById('viewDonorDetailsBtn');
        if (viewBtn) {
          viewBtn.addEventListener('click', function() {
            if (currentRequestData && currentRequestData.id) {
              fetchDonorHealthDetails(currentRequestData.id);
            }
          });
        }
      }

      // Hide appointment section for non-active statuses
      if (!config.showAppointment && appointmentSection) {
        appointmentSection.style.display = "none";
      } else if (config.showAppointment && appointmentSection) {
        appointmentSection.style.display = "";
      }

      // *** UPDATE SIDE PANEL - Contact Info ***
      const contactPhoneEl = document.getElementById("contactPhone");
      if (contactPhoneEl) {
        contactPhoneEl.textContent = request.contact_phone || "N/A";
      }

      const contactEmailEl = document.getElementById("contactEmail");
      if (contactEmailEl) {
        contactEmailEl.textContent = request.contact_email || "N/A";
      }

      // *** UPDATE SIDE PANEL - Hospital Info ***
      const hospitalNameEl = document.getElementById("hospitalName");
      if (hospitalNameEl) {
        hospitalNameEl.textContent = request.hospital_name || "N/A";
      }

      const hospitalAddressEl = document.getElementById("hospitalAddress");
      if (hospitalAddressEl) {
        hospitalAddressEl.textContent = request.city || "N/A";
      }

      const hospitalPhoneEl = document.getElementById("hospitalPhone");
      if (hospitalPhoneEl) {
        // Use contact phone if no hospital-specific phone available
        hospitalPhoneEl.textContent = request.contact_phone || "N/A";
      }

      // *** UPDATE SIDE PANEL - Appointment Info (when donor is assigned) ***
      if (config.showAppointment && request.donation) {
        const appointmentDateEl = document.getElementById("appointmentDate");
        if (appointmentDateEl) {
          appointmentDateEl.textContent = request.required_date || "TBD";
        }

        const appointmentTimeEl = document.getElementById("appointmentTime");
        if (appointmentTimeEl) {
          appointmentTimeEl.textContent = "As scheduled";
        }

        const appointmentDonorEl = document.getElementById("appointmentDonor");
        if (appointmentDonorEl) {
          appointmentDonorEl.textContent = request.donation.donor_name || "Assigned Donor";
        }

        const appointmentLocationEl = document.getElementById("appointmentLocation");
        if (appointmentLocationEl) {
          appointmentLocationEl.textContent = request.hospital_name || "N/A";
        }
      }
    }

    // Fetch and display request details
    async function loadRequestDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const requestId = urlParams.get("id");
      const requestCode = urlParams.get("code");

      if (!requestId && !requestCode) {
        showError(
          "No request ID specified. Please go back and select a request."
        );
        return;
      }

      // Page already has placeholder content, no need to call showLoading()
      // which would destroy the DOM elements that renderRequest() needs

      try {
        const queryParam = requestId
          ? `id=${requestId}`
          : `code=${requestCode}`;
        const response = await fetch(`/api/seeker/request.php?${queryParam}`);

        if (response.status === 401) {
          window.location.href = "/src/pages/auth/login.html";
          return;
        }

        if (response.status === 404) {
          showError(
            "Request not found or you do not have access to view it."
          );
          return;
        }

        const data = await response.json();

        if (!data.success) {
          showError(data.message || "Failed to load request details.");
          return;
        }

        renderRequest(data.request);
      } catch (error) {
        console.error("Error loading request:", error);
        showError("Unable to connect to the server. Please try again later.");
      }
    }

    document.addEventListener("DOMContentLoaded", loadRequestDetails);
  </script>
</body>

</html>