<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Track Requests - BloodConnect Seeker</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
  </head>

  <body class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div
      class="w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 flex flex-col"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="bg-red-600 p-2 rounded-lg">
            <i data-lucide="heart" class="size-6 text-white fill-white"></i>
          </div>
          <div>
            <div class="font-semibold text-red-600">BloodConnect</div>
            <div class="text-sm text-gray-500">Seeker Portal</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <a
          href="/src/pages/seeker/request.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="send" class="size-5"></i
          ><span>Submit Blood Request</span></a
        >
        <a
          href="/src/pages/seeker/tracking.html"
          class="flex items-center gap-3 px-6 py-3 text-red-600 bg-red-50 border-r-4 border-red-600"
          ><i data-lucide="clipboard-list" class="size-5"></i
          ><span>Track Request</span></a
        >
        <a
          href="/src/pages/seeker/chat.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="message-square" class="size-5"></i
          ><span>Chat with Donor</span></a
        >
      </nav>
      <div class="p-4 border-t border-gray-200">
        <div class="text-center text-sm text-gray-500">
          <p>Emergency: <span class="text-red-600 font-semibold">911</span></p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="h-16 bg-white border-b border-gray-200 fixed top-0 left-64 right-0 z-10 flex items-center justify-between px-8"
    >
      <div class="flex items-center gap-4 flex-1">
        <h2 class="text-lg font-semibold text-gray-900">Track Your Requests</h2>
      </div>
      <div class="flex items-center gap-4">
        <!-- Notification Dropdown -->
        <div class="relative" id="notificationDropdown">
          <button
            class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors"
            onclick="toggleNotifications()"
          >
            <i data-lucide="bell" class="size-5 text-gray-700"></i>
            <span
              class="absolute -top-1 -right-1 size-5 flex items-center justify-center bg-red-600 text-white text-xs rounded-full"
              id="notificationBadge"
              >2</span
            >
          </button>
          <!-- Notification Panel -->
          <div
            id="notificationPanel"
            class="hidden absolute right-0 top-12 w-80 bg-white border border-gray-200 rounded-xl shadow-xl z-50"
          >
            <div
              class="p-4 border-b border-gray-200 flex items-center justify-between"
            >
              <h3 class="font-semibold text-gray-900">Notifications</h3>
              <button
                onclick="markAllAsRead()"
                class="text-xs text-red-600 hover:text-red-700 font-medium"
              >
                Mark all as read
              </button>
            </div>
            <div class="max-h-80 overflow-y-auto" id="notificationList">
              <!-- Notifications populated by JS -->
            </div>
            <div class="p-3 border-t border-gray-200 text-center">
              <button
                class="text-sm text-red-600 hover:text-red-700 font-medium"
              >
                View all notifications
              </button>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
          <div class="text-right">
            <div class="text-sm font-medium text-gray-900" data-user-name>
              Guest User
            </div>
            <div class="text-xs text-gray-500" data-user-role>Blood Seeker</div>
          </div>
          <div
            class="size-10 bg-orange-100 rounded-full flex items-center justify-center"
          >
            <i data-lucide="user" class="size-5 text-orange-600"></i>
          </div>
        </div>
        <a href="/" class="p-2 text-gray-600 hover:text-red-600"
          ><i data-lucide="log-out" class="size-5"></i
        ></a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="ml-64 pt-16">
      <div class="p-8 space-y-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">
              Track Your Requests
            </h1>
            <p class="text-gray-600">
              View and monitor all your blood donation requests
            </p>
          </div>
          <a
            href="/src/pages/seeker/request.html"
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium flex items-center gap-2"
          >
            <i data-lucide="plus" class="size-4"></i>
            New Request
          </a>
        </div>

        <!-- Requests Grid -->
        <div id="requestsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Loading state -->
          <div
            class="col-span-2 p-12 bg-white border border-gray-200 rounded-xl text-center"
          >
            <div
              class="animate-spin size-12 border-4 border-red-600 border-t-transparent rounded-full mx-auto mb-4"
            ></div>
            <p class="text-gray-600">Loading your requests...</p>
          </div>
        </div>

        <!-- Summary Cards -->
        <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600 mb-1">Total Requests</p>
                <h2 id="totalCount" class="text-3xl font-bold text-gray-900">
                  0
                </h2>
              </div>
              <div class="bg-blue-100 p-3 rounded-lg">
                <i
                  data-lucide="clipboard-list"
                  class="size-6 text-blue-600"
                ></i>
              </div>
            </div>
          </div>
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600 mb-1">Active</p>
                <h2 id="activeCount" class="text-3xl font-bold text-gray-900">
                  0
                </h2>
              </div>
              <div class="bg-yellow-100 p-3 rounded-lg">
                <i data-lucide="clock" class="size-6 text-yellow-600"></i>
              </div>
            </div>
          </div>
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600 mb-1">Rejected</p>
                <h2 id="donorCount" class="text-3xl font-bold text-gray-900">
                  0
                </h2>
              </div>
              <div class="bg-red-100 p-3 rounded-lg">
                <i data-lucide="x-circle" class="size-6 text-red-600"></i>
              </div>
            </div>
          </div>
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-600 mb-1">Completed</p>
                <h2
                  id="completedCount"
                  class="text-3xl font-bold text-gray-900"
                >
                  0
                </h2>
              </div>
              <div class="bg-purple-100 p-3 rounded-lg">
                <i
                  data-lucide="check-circle"
                  class="size-6 text-purple-600"
                ></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module" src="/src/scripts/main.js"></script>
    <script>
      // Blood Seeker Tracking - Enhanced Lifecycle Tracking
      document.addEventListener("DOMContentLoaded", function () {
        // Lifecycle steps (in order)
        const lifecycleSteps = [
          { key: "submitted", label: "Submitted", icon: "send" },
          { key: "approved", label: "Approved", icon: "check-circle" },
          {
            key: "donor_assigned",
            label: "Donor Assigned",
            icon: "user-check",
          },
          { key: "on_the_way", label: "On the Way", icon: "navigation" },
          { key: "reached", label: "Reached", icon: "map-pin" },
          { key: "completed", label: "Completed", icon: "heart" },
        ];

        // Status mapping to seeker-friendly labels
        const statusConfig = {
          submitted: {
            label: "Request Submitted",
            message:
              "Your request has been submitted and is awaiting admin review.",
            color: "bg-gray-100 text-gray-700 border-gray-300",
            step: 0,
          },
          pending: {
            label: "Under Admin Review",
            message: "Your request is being reviewed by the admin.",
            color: "bg-yellow-100 text-yellow-800 border-yellow-300",
            step: 0,
          },
          rejected: {
            label: "Request Rejected",
            message:
              "Your request was rejected by admin. Please contact support for more information.",
            color: "bg-red-100 text-red-700 border-red-300",
            step: -1,
          },
          approved: {
            label: "Searching for Donor",
            message:
              "Your request has been approved and sent to compatible donors.",
            color: "bg-blue-100 text-blue-700 border-blue-300",
            step: 1,
          },
          in_progress: {
            label: "Donor Assigned",
            message:
              "A donor has accepted your request and is being processed.",
            color: "bg-indigo-100 text-indigo-700 border-indigo-300",
            step: 2,
          },
          donor_assigned: {
            label: "Donor Assigned",
            message: "A donor has accepted your request and will arrive soon.",
            color: "bg-indigo-100 text-indigo-700 border-indigo-300",
            step: 2,
          },
          on_the_way: {
            label: "Donor On the Way",
            message: "The donor is on their way to the hospital.",
            color: "bg-purple-100 text-purple-700 border-purple-300",
            step: 3,
          },
          reached: {
            label: "Donor Reached Hospital",
            message:
              "The donor has arrived at the hospital. Donation in progress.",
            color: "bg-teal-100 text-teal-700 border-teal-300",
            step: 4,
          },
          completed: {
            label: "Donation Completed",
            message:
              "Donation completed successfully. Thank you for using BloodConnect!",
            color: "bg-green-100 text-green-700 border-green-300",
            step: 5,
          },
        };

        // Blood requests data with lifecycle status - loaded from API
        let requests = [];

        // Fetch requests from API
        async function fetchRequests() {
          try {
            const response = await fetch("/api/seeker/requests.php");
            const data = await response.json();
            if (data.success) {
              requests = data.requests.map((req) => ({
                id: req.request_code,
                patientName: req.patient_name,
                bloodType: req.blood_type,
                quantity: req.quantity,
                hospital: req.hospital_name || "N/A",
                urgency: req.urgency === "emergency" ? "Emergency" : "Normal",
                status: req.lifecycle_status,
                requiredBy: req.required_date,
                submittedOn: new Date(req.created_at).toLocaleString(),
              }));
              renderRequests();

              // Update stats
              if (data.stats) {
                document.getElementById("totalCount").textContent =
                  data.stats.total;
                document.getElementById("activeCount").textContent =
                  data.stats.active;
                document.getElementById("completedCount").textContent =
                  data.stats.completed;
                document.getElementById("donorCount").textContent =
                  data.stats.rejected;
              }
            }
          } catch (error) {
            console.error("Failed to fetch requests:", error);
            showNotification("Failed to load requests", "error");
          }
        }

        const requestsContainer = document.getElementById("requestsGrid");

        function showEmptyState() {
          requestsContainer.innerHTML = `
          <div class="col-span-2 p-12 bg-white border border-gray-200 rounded-xl text-center">
            <i data-lucide="clipboard-list" class="size-12 text-gray-300 mx-auto mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Requests Yet</h3>
            <p class="text-gray-600 mb-4">You haven't submitted any blood requests yet.</p>
            <a href="/src/pages/seeker/request.html" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
              <i data-lucide="plus" class="size-4"></i>
              Submit Your First Request
            </a>
          </div>
        `;
          lucide.createIcons();
        }

        function getStatusInfo(status) {
          return statusConfig[status] || statusConfig["submitted"];
        }

        function getUrgencyBadge(urgency) {
          return urgency === "Emergency"
            ? "bg-red-600 text-white"
            : "bg-blue-600 text-white";
        }

        function renderTimeline(currentStep, isRejected) {
          if (isRejected) {
            return `
              <div class="flex items-center justify-center py-3 px-4 bg-red-50 rounded-lg border border-red-200">
                <i data-lucide="x-circle" class="size-5 text-red-500 mr-2"></i>
                <span class="text-sm text-red-700 font-medium">Request was rejected</span>
              </div>
            `;
          }

          return `
            <div class="flex items-center justify-between py-3 px-2 bg-gray-50 rounded-lg">
              ${lifecycleSteps
                .map((step, index) => {
                  const isCompleted = index < currentStep;
                  const isCurrent = index === currentStep;
                  const isFuture = index > currentStep;

                  let stepClass = "";
                  let iconClass = "";
                  let lineClass = "";

                  if (isCompleted) {
                    stepClass = "bg-green-500";
                    iconClass = "text-white";
                    lineClass = "bg-green-500";
                  } else if (isCurrent) {
                    stepClass = "bg-blue-500 ring-4 ring-blue-200";
                    iconClass = "text-white";
                    lineClass = "bg-gray-300";
                  } else {
                    stepClass = "bg-gray-200";
                    iconClass = "text-gray-400";
                    lineClass = "bg-gray-200";
                  }

                  return `
                  <div class="flex items-center ${
                    index < lifecycleSteps.length - 1 ? "flex-1" : ""
                  }">
                    <div class="flex flex-col items-center">
                      <div class="size-7 rounded-full ${stepClass} flex items-center justify-center" title="${
                        step.label
                      }">
                        <i data-lucide="${
                          isCompleted ? "check" : step.icon
                        }" class="size-3.5 ${iconClass}"></i>
                      </div>
                      <span class="text-[10px] mt-1 ${
                        isCurrent
                          ? "text-blue-600 font-semibold"
                          : isFuture
                            ? "text-gray-400"
                            : "text-green-600"
                      } text-center max-w-12 leading-tight">${step.label}</span>
                    </div>
                    ${
                      index < lifecycleSteps.length - 1
                        ? `<div class="flex-1 h-0.5 ${lineClass} mx-1 mt-[-16px]"></div>`
                        : ""
                    }
                  </div>
                `;
                })
                .join("")}
            </div>
          `;
        }

        function updateStats() {
          const total = requests.length;
          const active = requests.filter(
            (r) => r.status !== "completed" && r.status !== "rejected",
          ).length;
          const completed = requests.filter(
            (r) => r.status === "completed",
          ).length;
          const rejected = requests.filter(
            (r) => r.status === "rejected",
          ).length;

          document.getElementById("totalCount").textContent = total;
          document.getElementById("activeCount").textContent = active;
          document.getElementById("completedCount").textContent = completed;
          document.getElementById("donorCount").textContent = rejected;
        }

        function renderRequests() {
          if (!requests || requests.length === 0) {
            showEmptyState();
            return;
          }
          // Sort: active requests first (by most recent), then completed/rejected
          const sortedRequests = [...requests].sort((a, b) => {
            const aActive = a.status !== "completed" && a.status !== "rejected";
            const bActive = b.status !== "completed" && b.status !== "rejected";
            if (aActive && !bActive) return -1;
            if (!aActive && bActive) return 1;
            return new Date(b.submittedOn) - new Date(a.submittedOn);
          });

          requestsContainer.innerHTML = sortedRequests
            .map((req) => {
              const statusInfo = getStatusInfo(req.status);
              const isRejected = req.status === "rejected";
              const isCompleted = req.status === "completed";

              return `
            <div class="p-6 bg-white border ${
              isRejected
                ? "border-red-200"
                : isCompleted
                  ? "border-green-200"
                  : "border-gray-200"
            } rounded-xl hover:shadow-lg transition-shadow" data-id="${req.id}">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <h3 class="font-semibold text-gray-900">${req.id}</h3>
                    <span class="px-2 py-1 text-xs font-medium ${getUrgencyBadge(
                      req.urgency,
                    )} rounded-full">${req.urgency}</span>
                  </div>
                  <p class="text-sm text-gray-600">Patient: ${
                    req.patientName
                  }</p>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="droplet" class="size-5 text-red-600"></i>
                  <span class="font-bold text-red-600">${req.bloodType}</span>
                </div>
              </div>

              <!-- Request Details -->
              <div class="grid grid-cols-2 gap-2 mb-4 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-500">Quantity:</span>
                  <span class="text-gray-900 font-medium">${req.quantity} Unit${
                    req.quantity !== 1 ? "s" : ""
                  }</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">Hospital:</span>
                  <span class="text-gray-900 font-medium">${req.hospital}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">Submitted:</span>
                  <span class="text-gray-900">${
                    req.submittedOn.split(" ")[0]
                  }</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">Required By:</span>
                  <span class="text-gray-900 font-medium">${
                    req.requiredBy
                  }</span>
                </div>
              </div>

              <!-- Status Badge & Message -->
              <div class="mb-4 p-3 rounded-lg ${statusInfo.color} border">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-sm font-semibold">${statusInfo.label}</span>
                </div>
                <p class="text-xs opacity-80">${statusInfo.message}</p>
              </div>

              <!-- Timeline -->
              ${renderTimeline(statusInfo.step, isRejected)}

              <!-- Actions -->
              <div class="flex items-center justify-end pt-4 mt-4 border-t border-gray-100">
                <a href="/src/pages/seeker/request-details.html?code=${
                  req.id
                }" class="px-4 py-2 text-sm border border-gray-300 hover:bg-gray-100 rounded-lg flex items-center gap-2">
                  <i data-lucide="eye" class="size-4"></i>
                  View Details
                </a>
              </div>
            </div>
          `;
            })
            .join("");

          lucide.createIcons();
          updateStats();
        }

        function showNotification(message, type = "success") {
          const bgColor =
            type === "success"
              ? "bg-green-50 border-green-600"
              : "bg-blue-50 border-blue-600";
          const textColor =
            type === "success" ? "text-green-900" : "text-blue-900";
          const iconColor =
            type === "success" ? "text-green-600" : "text-blue-600";

          const notification = document.createElement("div");
          notification.className = `fixed top-20 right-8 p-4 ${bgColor} border-l-4 rounded-lg shadow-lg z-50`;
          notification.innerHTML = `
            <div class="flex items-center gap-3">
              <i data-lucide="check-circle" class="size-5 ${iconColor}"></i>
              <p class="${textColor}">${message}</p>
            </div>
          `;
          document.body.appendChild(notification);
          lucide.createIcons();
          setTimeout(() => notification.remove(), 3000);
        }

        // Initial render - fetch from API
        fetchRequests();
      });
    </script>
    <script type="module">
      import { initNotificationDropdown } from "/src/scripts/components/notification-dropdown.js";
      import { initUserLoader } from "/src/scripts/user-loader.js";
      initNotificationDropdown("seeker");
      initUserLoader();
    </script>
  </body>
</html>
