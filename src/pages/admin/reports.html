<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reports - BloodConnect Admin</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div
      class="w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 flex flex-col"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="bg-red-600 p-2 rounded-lg">
            <i data-lucide="heart" class="size-6 text-white fill-white"></i>
          </div>
          <div>
            <div class="font-semibold text-red-600">BloodConnect</div>
            <div class="text-sm text-gray-500">Admin Panel</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <a
          href="/src/pages/admin/dashboard.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="layout-dashboard" class="size-5"></i
          ><span>Dashboard</span></a
        >
        <a
          href="/src/pages/admin/donors.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="users" class="size-5"></i><span>Donors</span></a
        >
        <a
          href="/src/pages/admin/hospitals.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="building-2" class="size-5"></i
          ><span>Hospitals</span></a
        >
        <a
          href="/src/pages/admin/voluntary.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="hand-heart" class="size-5"></i
          ><span>Voluntary Donations</span></a
        >
        <a
          href="/src/pages/admin/blood-groups.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="droplet" class="size-5"></i
          ><span>Blood Groups</span></a
        >
        <a
          href="/src/pages/admin/reports.html"
          class="flex items-center gap-3 px-6 py-3 text-red-600 bg-red-50 border-r-4 border-red-600"
          ><i data-lucide="file-text" class="size-5"></i><span>Reports</span></a
        >
        <a
          href="/src/pages/admin/announcements.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="megaphone" class="size-5"></i
          ><span>Announcements</span></a
        >
        <a
          href="/src/pages/admin/chat.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="message-square" class="size-5"></i
          ><span>Chat</span></a
        >
      </nav>
      <div class="p-4 border-t border-gray-200">
        <div class="text-center text-sm text-gray-500">
          <p>Emergency: <span class="text-red-600 font-semibold">911</span></p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="h-16 bg-white border-b border-gray-200 fixed top-0 left-64 right-0 z-10 flex items-center justify-between px-8"
    >
      <div class="flex items-center gap-4 flex-1">
        <h2 class="text-lg font-semibold text-gray-900">Reports & Analytics</h2>
      </div>
      <div class="flex items-center gap-4">
        <!-- Notification Dropdown -->
        <div class="relative" id="notificationDropdown">
          <button
            class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors"
            onclick="toggleNotifications()"
            id="notificationBell"
          >
            <i data-lucide="bell" class="size-5 text-gray-700"></i>
            <span
              class="absolute -top-1 -right-1 size-5 flex items-center justify-center p-0 bg-red-600 text-white text-xs rounded-full hidden"
              id="notificationBadge"
              >0</span
            >
          </button>

          <!-- Notification Panel -->
          <div
            id="notificationPanel"
            class="hidden absolute right-0 top-12 w-80 bg-white border border-gray-200 rounded-xl shadow-xl z-50"
          >
            <div
              class="p-4 border-b border-gray-200 flex items-center justify-between"
            >
              <h3 class="font-semibold text-gray-900">Notifications</h3>
              <button
                onclick="markAllAsRead()"
                class="text-xs text-red-600 hover:text-red-700 font-medium"
              >
                Mark all as read
              </button>
            </div>
            <div class="max-h-80 overflow-y-auto" id="notificationList">
              <!-- Notifications will be populated by JS -->
            </div>
            <div class="p-3 border-t border-gray-200 text-center">
              <button
                class="text-sm text-red-600 hover:text-red-700 font-medium"
              >
                View all notifications
              </button>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
          <div class="text-right">
            <div class="text-sm font-medium text-gray-900">Admin User</div>
            <div class="text-xs text-gray-500">System Administrator</div>
          </div>
          <div
            class="size-10 bg-red-100 rounded-full flex items-center justify-center"
          >
            <i data-lucide="user" class="size-5 text-red-600"></i>
          </div>
        </div>
        <a href="/" class="p-2 text-gray-600 hover:text-red-600"
          ><i data-lucide="log-out" class="size-5"></i
        ></a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="ml-64 pt-16">
      <div class="p-8 space-y-8">
        <!-- Page Header -->
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">
              Reports & Analytics
            </h1>
            <p class="text-gray-600">Generate and download system reports</p>
          </div>
          <div class="flex gap-3">
            <button
              id="filterBtn"
              class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium"
              onclick="toggleFilterPanel()"
            >
              <i data-lucide="filter" class="size-4 mr-2"></i>
              Filter
            </button>
            <button
              id="dateRangeBtn"
              class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium"
              onclick="toggleDateRangePanel()"
            >
              <i data-lucide="calendar" class="size-4 mr-2"></i>
              Date Range
            </button>
          </div>
        </div>

        <!-- Filter Panel (Hidden by default) -->
        <div
          id="filterPanel"
          class="hidden p-6 bg-white border border-gray-200 rounded-xl"
        >
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="text-gray-700 mb-2 block font-medium text-sm"
                >Blood Group</label
              >
              <select
                id="filterBloodGroup"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              >
                <option value="">All Blood Groups</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div>
              <label class="text-gray-700 mb-2 block font-medium text-sm"
                >Status</label
              >
              <select
                id="filterStatus"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              >
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="completed">Completed</option>
                <option value="rejected">Rejected</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div>
              <label class="text-gray-700 mb-2 block font-medium text-sm"
                >Start Date</label
              >
              <input
                type="date"
                id="filterStartDate"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              />
            </div>
            <div>
              <label class="text-gray-700 mb-2 block font-medium text-sm"
                >End Date</label
              >
              <input
                type="date"
                id="filterEndDate"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              />
            </div>
          </div>
          <div class="flex gap-3 mt-4">
            <button
              onclick="applyFilters()"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium"
            >
              Apply Filters
            </button>
            <button
              onclick="resetFilters()"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium"
            >
              Reset
            </button>
          </div>
        </div>

        <!-- Date Range Quick Select Panel (Hidden by default) -->
        <div
          id="dateRangePanel"
          class="hidden p-6 bg-white border border-gray-200 rounded-xl"
        >
          <div class="flex flex-wrap gap-3">
            <button
              onclick="setDateRange(7)"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-red-50 hover:border-red-300 hover:text-red-600 font-medium"
            >
              Last 7 Days
            </button>
            <button
              onclick="setDateRange(30)"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-red-50 hover:border-red-300 hover:text-red-600 font-medium"
            >
              Last 30 Days
            </button>
            <button
              onclick="setDateRange(90)"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-red-50 hover:border-red-300 hover:text-red-600 font-medium"
            >
              Last 3 Months
            </button>
            <button
              onclick="setDateRange(180)"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-red-50 hover:border-red-300 hover:text-red-600 font-medium"
            >
              Last 6 Months
            </button>
            <button
              onclick="setDateRange(365)"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-red-50 hover:border-red-300 hover:text-red-600 font-medium"
            >
              Last Year
            </button>
          </div>
        </div>

        <!-- Quick Reports Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div
            class="p-6 bg-white border border-gray-200 rounded-xl hover:shadow-lg transition-shadow cursor-pointer"
          >
            <div class="flex items-center justify-between mb-4">
              <div class="bg-red-100 p-3 rounded-lg">
                <i data-lucide="file-text" class="size-6 text-red-600"></i>
              </div>
              <div id="donorReportLoading" class="hidden">
                <i
                  data-lucide="loader-2"
                  class="size-5 text-gray-400 animate-spin"
                ></i>
              </div>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">
              Donor Report
            </h3>
            <p class="text-gray-600 mb-4">Complete donor statistics</p>
            <button
              id="downloadDonorReport"
              onclick="downloadReport('donor', 'csv')"
              class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium inline-flex items-center justify-center"
            >
              <i data-lucide="download" class="size-4 mr-2"></i>
              Download CSV
            </button>
          </div>

          <div
            class="p-6 bg-white border border-gray-200 rounded-xl hover:shadow-lg transition-shadow cursor-pointer"
          >
            <div class="flex items-center justify-between mb-4">
              <div class="bg-blue-100 p-3 rounded-lg">
                <i data-lucide="building-2" class="size-6 text-blue-600"></i>
              </div>
              <div id="hospitalReportLoading" class="hidden">
                <i
                  data-lucide="loader-2"
                  class="size-5 text-gray-400 animate-spin"
                ></i>
              </div>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">
              Hospital Report
            </h3>
            <p class="text-gray-600 mb-4">Hospital activity summary</p>
            <button
              id="downloadHospitalReport"
              onclick="downloadReport('hospital', 'csv')"
              class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium inline-flex items-center justify-center"
            >
              <i data-lucide="download" class="size-4 mr-2"></i>
              Download CSV
            </button>
          </div>

          <div
            class="p-6 bg-white border border-gray-200 rounded-xl hover:shadow-lg transition-shadow cursor-pointer"
          >
            <div class="flex items-center justify-between mb-4">
              <div class="bg-purple-100 p-3 rounded-lg">
                <i data-lucide="file-text" class="size-6 text-purple-600"></i>
              </div>
              <div id="monthlyReportLoading" class="hidden">
                <i
                  data-lucide="loader-2"
                  class="size-5 text-gray-400 animate-spin"
                ></i>
              </div>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">
              Monthly Summary
            </h3>
            <p class="text-gray-600 mb-4">Comprehensive overview</p>
            <button
              id="downloadMonthlyReport"
              onclick="downloadReport('monthly', 'csv')"
              class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium inline-flex items-center justify-center"
            >
              <i data-lucide="download" class="size-4 mr-2"></i>
              Download CSV
            </button>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Line Chart - Donations vs Requests -->
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <div class="mb-6">
              <h2 class="text-lg font-semibold text-gray-900 mb-1">
                Donations vs Requests
              </h2>
              <p class="text-sm text-gray-600">Monthly comparison</p>
            </div>
            <div class="h-75 relative">
              <div
                id="lineChartLoading"
                class="absolute inset-0 flex items-center justify-center bg-white"
              >
                <div class="flex flex-col items-center gap-2">
                  <i
                    data-lucide="loader-2"
                    class="size-8 text-red-600 animate-spin"
                  ></i>
                  <span class="text-sm text-gray-500">Loading chart...</span>
                </div>
              </div>
              <canvas id="lineChart"></canvas>
            </div>
          </div>

          <!-- Pie Chart - Blood Type Distribution -->
          <div class="p-6 bg-white border border-gray-200 rounded-xl">
            <div class="mb-6">
              <h2 class="text-lg font-semibold text-gray-900 mb-1">
                Blood Type Distribution
              </h2>
              <p class="text-sm text-gray-600">Donor count by blood type</p>
            </div>
            <div class="h-75 relative">
              <div
                id="pieChartLoading"
                class="absolute inset-0 flex items-center justify-center bg-white"
              >
                <div class="flex flex-col items-center gap-2">
                  <i
                    data-lucide="loader-2"
                    class="size-8 text-red-600 animate-spin"
                  ></i>
                  <span class="text-sm text-gray-500">Loading chart...</span>
                </div>
              </div>
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Bar Chart - Monthly User Registration Report -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">
              Monthly User Registration Report
            </h2>
            <p class="text-sm text-gray-600">
              New registrations by user type over time
            </p>
          </div>
          <!-- Registration Summary Stats -->
          <div id="registrationStats" class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-red-50 p-4 rounded-lg text-center">
              <p class="text-2xl font-bold text-red-600" id="totalDonorsReg">
                0
              </p>
              <p class="text-sm text-gray-600">Donors</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg text-center">
              <p
                class="text-2xl font-bold text-blue-600"
                id="totalHospitalsReg"
              >
                0
              </p>
              <p class="text-sm text-gray-600">Hospitals</p>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg text-center">
              <p
                class="text-2xl font-bold text-orange-600"
                id="totalSeekersReg"
              >
                0
              </p>
              <p class="text-sm text-gray-600">Seekers</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg text-center">
              <p class="text-2xl font-bold text-purple-600" id="totalUsersReg">
                0
              </p>
              <p class="text-sm text-gray-600">Total</p>
            </div>
          </div>
          <div class="h-87.5 relative">
            <div
              id="barChartLoading"
              class="absolute inset-0 flex items-center justify-center bg-white"
            >
              <div class="flex flex-col items-center gap-2">
                <i
                  data-lucide="loader-2"
                  class="size-8 text-red-600 animate-spin"
                ></i>
                <span class="text-sm text-gray-500">Loading chart...</span>
              </div>
            </div>
            <canvas id="barChart"></canvas>
          </div>
        </div>

        <!-- Custom Report Generator -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">
              Custom Report Generator
            </h2>
            <p class="text-sm text-gray-600">
              Create a custom report with specific parameters
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div>
              <label class="text-gray-700 mb-2 block font-medium"
                >Report Type</label
              >
              <select
                id="customReportType"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              >
                <option value="Donor Report">Donor Report</option>
                <option value="Hospital Report">Hospital Report</option>
                <option value="Blood Inventory">Blood Inventory</option>
                <option value="Request History">Request History</option>
              </select>
            </div>
            <div>
              <label class="text-gray-700 mb-2 block font-medium"
                >Date Range</label
              >
              <select
                id="customDateRange"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                onchange="handleCustomDateRangeChange()"
              >
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 3 Months</option>
                <option value="365">Last Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div id="customStartDateContainer" class="hidden">
              <label class="text-gray-700 mb-2 block font-medium"
                >Start Date</label
              >
              <input
                type="date"
                id="customStartDate"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              />
            </div>
            <div id="customEndDateContainer" class="hidden">
              <label class="text-gray-700 mb-2 block font-medium"
                >End Date</label
              >
              <input
                type="date"
                id="customEndDate"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              />
            </div>
            <div>
              <label class="text-gray-700 mb-2 block font-medium"
                >Blood Group (Optional)</label
              >
              <select
                id="customBloodGroup"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              >
                <option value="">All Blood Groups</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div>
              <label class="text-gray-700 mb-2 block font-medium">Format</label>
              <select
                id="customFormat"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              >
                <option value="preview">Preview First</option>
                <option value="csv">CSV</option>
              </select>
            </div>
          </div>

          <button
            id="generateCustomReportBtn"
            class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium inline-flex items-center"
            onclick="generateCustomReport()"
          >
            <i data-lucide="file-text" class="size-4 mr-2"></i>
            Generate Custom Report
          </button>
        </div>

        <!-- Custom Report Preview Section (Hidden by default) -->
        <div
          id="customReportPreview"
          class="hidden p-6 bg-white border border-gray-200 rounded-xl"
        >
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2
                id="previewTitle"
                class="text-lg font-semibold text-gray-900 mb-1"
              >
                Report Preview
              </h2>
              <p id="previewSubtitle" class="text-sm text-gray-600">
                Generated report data
              </p>
            </div>
            <div class="flex gap-3">
              <button
                onclick="downloadPreviewReport('csv')"
                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium inline-flex items-center"
              >
                <i data-lucide="download" class="size-4 mr-2"></i>
                Download CSV
              </button>
              <button
                onclick="closePreview()"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium"
              >
                Close
              </button>
            </div>
          </div>

          <!-- Summary Stats -->
          <div id="previewSummary" class="grid grid-cols-4 gap-4 mb-6">
            <!-- Dynamically populated -->
          </div>

          <!-- Data Table -->
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="w-full" id="previewTable">
              <thead class="bg-gray-50" id="previewTableHead">
                <!-- Dynamically populated -->
              </thead>
              <tbody id="previewTableBody">
                <!-- Dynamically populated -->
              </tbody>
            </table>
          </div>
          <p
            id="previewRecordCount"
            class="text-sm text-gray-500 mt-2 italic"
          ></p>
        </div>
      </div>
    </main>

    <!-- Error Toast -->
    <div id="errorToast" class="fixed bottom-4 right-4 hidden z-50">
      <div
        class="bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3"
      >
        <i data-lucide="alert-circle" class="size-5"></i>
        <span id="errorToastMessage">An error occurred</span>
        <button
          onclick="hideErrorToast()"
          class="ml-2 hover:bg-red-700 p-1 rounded"
        >
          <i data-lucide="x" class="size-4"></i>
        </button>
      </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed bottom-4 right-4 hidden z-50">
      <div
        class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3"
      >
        <i data-lucide="check-circle" class="size-5"></i>
        <span id="successToastMessage">Success</span>
        <button
          onclick="hideSuccessToast()"
          class="ml-2 hover:bg-green-700 p-1 rounded"
        >
          <i data-lucide="x" class="size-4"></i>
        </button>
      </div>
    </div>

    <script>
      // =====================================================
      // GLOBAL STATE
      // =====================================================
      let currentFilters = {
        startDate: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000)
          .toISOString()
          .split("T")[0],
        endDate: new Date().toISOString().split("T")[0],
        bloodGroup: "",
        status: "",
      };

      let chartData = null;
      let registrationData = null;
      let lineChartInstance = null;
      let pieChartInstance = null;
      let barChartInstance = null;
      let currentPreviewData = null;

      // =====================================================
      // INITIALIZATION
      // =====================================================
      document.addEventListener("DOMContentLoaded", function () {
        // Set default dates in filter inputs
        document.getElementById("filterStartDate").value =
          currentFilters.startDate;
        document.getElementById("filterEndDate").value = currentFilters.endDate;

        // Load initial data
        loadChartData();

        // Initialize Lucide icons
        if (window.lucide) {
          window.lucide.createIcons();
        }
      });

      // =====================================================
      // FILTER FUNCTIONS
      // =====================================================
      function toggleFilterPanel() {
        const panel = document.getElementById("filterPanel");
        const datePanel = document.getElementById("dateRangePanel");
        datePanel.classList.add("hidden");
        panel.classList.toggle("hidden");
      }

      function toggleDateRangePanel() {
        const panel = document.getElementById("dateRangePanel");
        const filterPanel = document.getElementById("filterPanel");
        filterPanel.classList.add("hidden");
        panel.classList.toggle("hidden");
      }

      function setDateRange(days) {
        const endDate = new Date();
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);

        currentFilters.startDate = startDate.toISOString().split("T")[0];
        currentFilters.endDate = endDate.toISOString().split("T")[0];

        document.getElementById("filterStartDate").value =
          currentFilters.startDate;
        document.getElementById("filterEndDate").value = currentFilters.endDate;

        document.getElementById("dateRangePanel").classList.add("hidden");
        loadChartData();
        showSuccessToast("Date range updated");
      }

      function applyFilters() {
        currentFilters.startDate =
          document.getElementById("filterStartDate").value ||
          currentFilters.startDate;
        currentFilters.endDate =
          document.getElementById("filterEndDate").value ||
          currentFilters.endDate;
        currentFilters.bloodGroup =
          document.getElementById("filterBloodGroup").value;
        currentFilters.status = document.getElementById("filterStatus").value;

        document.getElementById("filterPanel").classList.add("hidden");
        loadChartData();
        showSuccessToast("Filters applied");
      }

      function resetFilters() {
        currentFilters = {
          startDate: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0],
          endDate: new Date().toISOString().split("T")[0],
          bloodGroup: "",
          status: "",
        };

        document.getElementById("filterStartDate").value =
          currentFilters.startDate;
        document.getElementById("filterEndDate").value = currentFilters.endDate;
        document.getElementById("filterBloodGroup").value = "";
        document.getElementById("filterStatus").value = "";

        loadChartData();
        showSuccessToast("Filters reset");
      }

      // =====================================================
      // CHART DATA LOADING
      // =====================================================
      async function loadChartData() {
        showChartLoading(true);

        try {
          const params = new URLSearchParams({
            action: "chart_data",
            start_date: currentFilters.startDate,
            end_date: currentFilters.endDate,
          });

          if (currentFilters.bloodGroup) {
            params.append("blood_group", currentFilters.bloodGroup);
          }

          const response = await fetch(`/api/admin/reports.php?${params}`, {
            credentials: "include",
          });

          const data = await response.json();

          if (data.success) {
            chartData = data;
            renderLineChart();
            renderPieChart();
          } else {
            showErrorToast(data.message || "Failed to load chart data");
            renderLineChart(true);
            renderPieChart(true);
          }

          // Load registration data separately
          await loadRegistrationData();
        } catch (error) {
          console.error("Error loading chart data:", error);
          showErrorToast("Failed to connect to server");
          renderEmptyCharts();
        } finally {
          showChartLoading(false);
        }
      }

      async function loadRegistrationData() {
        try {
          const params = new URLSearchParams({
            action: "monthly_registrations",
            start_date: currentFilters.startDate,
            end_date: currentFilters.endDate,
          });

          const response = await fetch(`/api/admin/reports.php?${params}`, {
            credentials: "include",
          });

          const data = await response.json();

          if (data.success) {
            registrationData = data;
            updateRegistrationStats(data.totals);
            renderBarChart();
          } else {
            renderBarChart(true);
          }
        } catch (error) {
          console.error("Error loading registration data:", error);
          renderBarChart(true);
        }
      }

      function updateRegistrationStats(totals) {
        document.getElementById("totalDonorsReg").textContent =
          totals.donors || 0;
        document.getElementById("totalHospitalsReg").textContent =
          totals.hospitals || 0;
        document.getElementById("totalSeekersReg").textContent =
          totals.seekers || 0;
        document.getElementById("totalUsersReg").textContent =
          totals.total || 0;
      }

      function showChartLoading(show) {
        const loaders = [
          "lineChartLoading",
          "pieChartLoading",
          "barChartLoading",
        ];
        loaders.forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            el.classList.toggle("hidden", !show);
          }
        });
      }

      // =====================================================
      // CHART RENDERING
      // =====================================================
      function renderCharts() {
        renderLineChart();
        renderPieChart();
        renderBarChart();
      }

      function renderEmptyCharts() {
        renderLineChart(true);
        renderPieChart(true);
        renderBarChart(true);
        // Reset registration stats
        updateRegistrationStats({
          donors: 0,
          hospitals: 0,
          seekers: 0,
          total: 0,
        });
      }

      function renderLineChart(empty = false) {
        const ctx = document.getElementById("lineChart").getContext("2d");

        if (lineChartInstance) {
          lineChartInstance.destroy();
        }

        const monthlyTrends =
          empty || !chartData?.monthly_trends?.length
            ? []
            : chartData.monthly_trends;

        if (monthlyTrends.length === 0) {
          lineChartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels: ["No Data"],
              datasets: [
                {
                  label: "Donations",
                  data: [0],
                  borderColor: "#EF4444",
                  backgroundColor: "rgba(239, 68, 68, 0.1)",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: "No data available for selected period",
                  color: "#6B7280",
                },
              },
            },
          });
          return;
        }

        lineChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: monthlyTrends.map((d) => d.month_label),
            datasets: [
              {
                label: "Donations",
                data: monthlyTrends.map((d) => d.donations),
                borderColor: "#EF4444",
                backgroundColor: "rgba(239, 68, 68, 0.1)",
                borderWidth: 2,
                tension: 0.3,
                fill: false,
              },
              {
                label: "Requests",
                data: monthlyTrends.map((d) => d.requests),
                borderColor: "#3B82F6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 2,
                tension: 0.3,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
              },
              x: {
                grid: {
                  display: false,
                },
              },
            },
          },
        });
      }

      function renderPieChart(empty = false) {
        const ctx = document.getElementById("pieChart").getContext("2d");

        if (pieChartInstance) {
          pieChartInstance.destroy();
        }

        const bloodTypes =
          empty || !chartData?.blood_type_distribution?.length
            ? []
            : chartData.blood_type_distribution;

        if (bloodTypes.length === 0) {
          pieChartInstance = new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["No Data"],
              datasets: [
                {
                  data: [1],
                  backgroundColor: ["#E5E7EB"],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: "No blood type data available",
                  color: "#6B7280",
                },
              },
            },
          });
          return;
        }

        pieChartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: bloodTypes.map((d) => d.name),
            datasets: [
              {
                data: bloodTypes.map((d) => d.value),
                backgroundColor: bloodTypes.map((d) => d.color),
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
                labels: {
                  usePointStyle: true,
                  padding: 15,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0,
                    );
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} donors (${percentage}%)`;
                  },
                },
              },
            },
          },
        });
      }

      function renderBarChart(empty = false) {
        const ctx = document.getElementById("barChart").getContext("2d");

        if (barChartInstance) {
          barChartInstance.destroy();
        }

        const monthlyRegs =
          empty || !registrationData?.monthly_registrations?.length
            ? []
            : registrationData.monthly_registrations;

        if (monthlyRegs.length === 0) {
          barChartInstance = new Chart(ctx, {
            type: "bar",
            data: {
              labels: ["No Data"],
              datasets: [
                {
                  label: "Donors",
                  data: [0],
                  backgroundColor: "#EF4444",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: "No registration data available",
                  color: "#6B7280",
                },
              },
            },
          });
          return;
        }

        barChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: monthlyRegs.map((d) => d.month_label),
            datasets: [
              {
                label: "Donors",
                data: monthlyRegs.map((d) => d.donors),
                backgroundColor: "#EF4444",
                borderRadius: 4,
              },
              {
                label: "Hospitals",
                data: monthlyRegs.map((d) => d.hospitals),
                backgroundColor: "#3B82F6",
                borderRadius: 4,
              },
              {
                label: "Seekers",
                data: monthlyRegs.map((d) => d.seekers),
                backgroundColor: "#F97316",
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
              tooltip: {
                callbacks: {
                  afterTitle: function (context) {
                    const dataIndex = context[0].dataIndex;
                    const total =
                      monthlyRegs[dataIndex].donors +
                      monthlyRegs[dataIndex].hospitals +
                      monthlyRegs[dataIndex].seekers;
                    return `Total: ${total} registrations`;
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                ticks: {
                  stepSize: 1,
                  precision: 0,
                },
              },
              x: {
                grid: {
                  display: false,
                },
              },
            },
          },
        });
      }

      // =====================================================
      // REPORT DOWNLOAD
      // =====================================================
      async function downloadReport(type, format) {
        const loadingId = `${type}ReportLoading`;
        const loadingEl = document.getElementById(loadingId);

        if (loadingEl) {
          loadingEl.classList.remove("hidden");
        }

        try {
          const params = new URLSearchParams({
            action: "download",
            report_type: type,
            format: format,
            start_date: currentFilters.startDate,
            end_date: currentFilters.endDate,
          });

          if (currentFilters.bloodGroup) {
            params.append("blood_group", currentFilters.bloodGroup);
          }
          if (currentFilters.status) {
            params.append("status", currentFilters.status);
          }

          const response = await fetch(`/api/admin/reports.php?${params}`, {
            credentials: "include",
          });

          if (format === "csv") {
            // For CSV, we get direct file download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${type}_report_${new Date().toISOString().split("T")[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            showSuccessToast("Report downloaded successfully");
          }
        } catch (error) {
          console.error("Error downloading report:", error);
          showErrorToast("Failed to download report");
        } finally {
          if (loadingEl) {
            loadingEl.classList.add("hidden");
          }
        }
      }

      // =====================================================
      // CUSTOM REPORT GENERATOR
      // =====================================================
      function handleCustomDateRangeChange() {
        const value = document.getElementById("customDateRange").value;
        const startContainer = document.getElementById(
          "customStartDateContainer",
        );
        const endContainer = document.getElementById("customEndDateContainer");

        if (value === "custom") {
          startContainer.classList.remove("hidden");
          endContainer.classList.remove("hidden");
        } else {
          startContainer.classList.add("hidden");
          endContainer.classList.add("hidden");
        }
      }

      async function generateCustomReport() {
        const btn = document.getElementById("generateCustomReportBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<i data-lucide="loader-2" class="size-4 mr-2 animate-spin"></i> Generating...';

        try {
          const reportType = document.getElementById("customReportType").value;
          const dateRangeValue =
            document.getElementById("customDateRange").value;
          const bloodGroup = document.getElementById("customBloodGroup").value;
          const format = document.getElementById("customFormat").value;

          let startDate, endDate;

          if (dateRangeValue === "custom") {
            startDate = document.getElementById("customStartDate").value;
            endDate = document.getElementById("customEndDate").value;

            if (!startDate || !endDate) {
              showErrorToast("Please select both start and end dates");
              return;
            }
          } else {
            const days = parseInt(dateRangeValue);
            endDate = new Date().toISOString().split("T")[0];
            startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
              .toISOString()
              .split("T")[0];
          }

          if (format === "csv") {
            // Direct download
            await downloadCustomReport(
              reportType,
              startDate,
              endDate,
              bloodGroup,
              "csv",
            );
          } else {
            // Preview first
            await loadCustomReportPreview(
              reportType,
              startDate,
              endDate,
              bloodGroup,
            );
          }
        } catch (error) {
          console.error("Error generating custom report:", error);
          showErrorToast("Failed to generate report");
        } finally {
          btn.disabled = false;
          btn.innerHTML =
            '<i data-lucide="file-text" class="size-4 mr-2"></i> Generate Custom Report';
          if (window.lucide) {
            window.lucide.createIcons();
          }
        }
      }

      async function loadCustomReportPreview(
        reportType,
        startDate,
        endDate,
        bloodGroup,
      ) {
        const params = new URLSearchParams({
          action: "custom",
          report_type: reportType,
          start_date: startDate,
          end_date: endDate,
        });

        if (bloodGroup) {
          params.append("blood_group", bloodGroup);
        }

        const response = await fetch(`/api/admin/reports.php?${params}`, {
          credentials: "include",
        });

        const data = await response.json();

        if (data.success) {
          currentPreviewData = {
            type: reportType,
            startDate,
            endDate,
            bloodGroup,
            data,
          };
          renderPreview(data, reportType, startDate, endDate);
        } else {
          showErrorToast(data.message || "Failed to generate report");
        }
      }

      function renderPreview(report, reportType, startDate, endDate) {
        const previewSection = document.getElementById("customReportPreview");
        const summaryContainer = document.getElementById("previewSummary");
        const tableHead = document.getElementById("previewTableHead");
        const tableBody = document.getElementById("previewTableBody");
        const recordCount = document.getElementById("previewRecordCount");

        document.getElementById("previewTitle").textContent = reportType;
        document.getElementById("previewSubtitle").textContent =
          `Period: ${formatDate(startDate)} - ${formatDate(endDate)}`;

        // Render summary stats
        if (report.summary) {
          const summaryColors = ["red", "blue", "green", "purple"];
          let summaryHTML = "";
          let colorIndex = 0;

          for (const [key, value] of Object.entries(report.summary)) {
            if (typeof value !== "object") {
              const color = summaryColors[colorIndex % summaryColors.length];
              summaryHTML += `
                <div class="bg-${color}-50 p-4 rounded-lg text-center">
                  <p class="text-3xl font-bold text-${color}-600">${formatNumber(value)}</p>
                  <p class="text-sm text-gray-600">${formatLabel(key)}</p>
                </div>
              `;
              colorIndex++;
            }
          }
          summaryContainer.innerHTML = summaryHTML;
        }

        // Render data table
        if (report.data && report.data.length > 0) {
          const columns = Object.keys(report.data[0]);

          // Header
          tableHead.innerHTML = `
            <tr>
              ${columns.map((col) => `<th class="text-left py-3 px-4 text-sm font-medium text-gray-600">${formatLabel(col)}</th>`).join("")}
            </tr>
          `;

          // Body (limit to 10 rows for preview)
          const previewRows = report.data.slice(0, 10);
          tableBody.innerHTML = previewRows
            .map(
              (row) => `
            <tr class="border-t border-gray-100">
              ${columns.map((col) => `<td class="py-3 px-4 text-gray-600">${formatCellValue(row[col], col)}</td>`).join("")}
            </tr>
          `,
            )
            .join("");

          recordCount.textContent = `Showing ${previewRows.length} of ${report.data.length} records. Download full report for all data.`;
        } else {
          tableHead.innerHTML =
            '<tr><th class="text-left py-3 px-4 text-gray-600">No Data</th></tr>';
          tableBody.innerHTML =
            '<tr><td class="py-3 px-4 text-gray-500">No records found for the selected criteria.</td></tr>';
          recordCount.textContent = "";
        }

        previewSection.classList.remove("hidden");
        previewSection.scrollIntoView({ behavior: "smooth" });
      }

      async function downloadCustomReport(
        reportType,
        startDate,
        endDate,
        bloodGroup,
        format,
      ) {
        const params = new URLSearchParams({
          action: "download",
          report_type: reportType.toLowerCase().includes("donor")
            ? "donor"
            : reportType.toLowerCase().includes("hospital")
              ? "hospital"
              : reportType.toLowerCase().includes("request")
                ? "request"
                : "donation",
          format: format,
          start_date: startDate,
          end_date: endDate,
        });

        if (bloodGroup) {
          params.append("blood_group", bloodGroup);
        }

        const response = await fetch(`/api/admin/reports.php?${params}`, {
          credentials: "include",
        });

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `custom_report_${new Date().toISOString().split("T")[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        showSuccessToast("Report downloaded successfully");
      }

      async function downloadPreviewReport(format) {
        if (!currentPreviewData) {
          showErrorToast("No report data to download");
          return;
        }

        await downloadCustomReport(
          currentPreviewData.type,
          currentPreviewData.startDate,
          currentPreviewData.endDate,
          currentPreviewData.bloodGroup,
          format,
        );
      }

      function closePreview() {
        document.getElementById("customReportPreview").classList.add("hidden");
        currentPreviewData = null;
      }

      // =====================================================
      // UTILITY FUNCTIONS
      // =====================================================
      function formatDate(dateStr) {
        return new Date(dateStr).toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function formatNumber(value) {
        if (typeof value === "number") {
          if (value % 1 !== 0) {
            return (
              value.toFixed(1) + (value.toString().includes("%") ? "" : "")
            );
          }
          return value.toLocaleString();
        }
        return value;
      }

      function formatLabel(key) {
        return key.replace(/_/g, " ").replace(/\b\w/g, (l) => l.toUpperCase());
      }

      function formatCellValue(value, column) {
        if (value === null || value === undefined) return "-";

        if (column.includes("date") || column.includes("_at")) {
          const date = new Date(value);
          if (!isNaN(date.getTime())) {
            return date.toLocaleDateString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
            });
          }
        }

        if (column === "status") {
          const colors = {
            pending: "bg-yellow-100 text-yellow-700",
            approved: "bg-green-100 text-green-700",
            completed: "bg-green-100 text-green-700",
            rejected: "bg-red-100 text-red-700",
            cancelled: "bg-gray-100 text-gray-700",
          };
          const colorClass = colors[value] || "bg-gray-100 text-gray-700";
          return `<span class="px-2 py-1 text-xs font-medium ${colorClass} rounded-full">${value}</span>`;
        }

        if (column === "blood_group" || column === "blood_type") {
          return `<span class="px-2 py-1 text-xs font-medium border border-red-600 text-red-600 rounded-full">${value}</span>`;
        }

        return value;
      }

      // =====================================================
      // TOAST NOTIFICATIONS
      // =====================================================
      function showErrorToast(message) {
        const toast = document.getElementById("errorToast");
        const messageEl = document.getElementById("errorToastMessage");
        messageEl.textContent = message;
        toast.classList.remove("hidden");

        if (window.lucide) {
          window.lucide.createIcons();
        }

        setTimeout(() => {
          toast.classList.add("hidden");
        }, 5000);
      }

      function hideErrorToast() {
        document.getElementById("errorToast").classList.add("hidden");
      }

      function showSuccessToast(message) {
        const toast = document.getElementById("successToast");
        const messageEl = document.getElementById("successToastMessage");
        messageEl.textContent = message;
        toast.classList.remove("hidden");

        if (window.lucide) {
          window.lucide.createIcons();
        }

        setTimeout(() => {
          toast.classList.add("hidden");
        }, 3000);
      }

      function hideSuccessToast() {
        document.getElementById("successToast").classList.add("hidden");
      }

      // =====================================================
      // NOTIFICATION SYSTEM
      // =====================================================
      let notifications = [];

      async function loadNotifications() {
        try {
          notifications = [];
          renderNotifications();
        } catch (error) {
          console.error("Error loading notifications:", error);
          notifications = [];
          renderNotifications();
        }
      }

      function renderNotifications() {
        const container = document.getElementById("notificationList");
        const unreadCount = notifications.filter((n) => !n.read).length;
        const badge = document.getElementById("notificationBadge");

        if (unreadCount > 0) {
          badge.textContent = unreadCount;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }

        if (notifications.length === 0) {
          container.innerHTML =
            '<div class="p-4 text-center text-gray-500">No notifications</div>';
          return;
        }

        container.innerHTML = notifications
          .map(
            (n) => `
          <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors ${n.read ? "opacity-70" : ""}" data-id="${n.id}" onclick="markAsRead(${n.id})">
            <div class="flex gap-3">
              <div class="${n.iconBg} p-2 rounded-lg h-fit"><i data-lucide="${n.icon}" class="size-4 ${n.iconColor}"></i></div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                  <p class="text-sm ${n.read ? "font-normal text-gray-700" : "font-semibold text-gray-900"} truncate">${n.title}</p>
                  ${!n.read ? '<span class="size-2 bg-red-600 rounded-full flex-shrink-0 mt-1.5"></span>' : ""}
                </div>
                <p class="text-xs text-gray-500 mt-0.5 line-clamp-1">${n.message}</p>
                <p class="text-xs text-gray-400 mt-1">${n.time}</p>
              </div>
            </div>
          </div>
        `,
          )
          .join("");

        if (window.lucide) {
          window.lucide.createIcons();
        }
      }

      function toggleNotifications() {
        const panel = document.getElementById("notificationPanel");
        panel.classList.toggle("hidden");
        if (!panel.classList.contains("hidden")) {
          renderNotifications();
        }
      }

      function markAsRead(id) {
        const n = notifications.find((x) => x.id === id);
        if (n) {
          n.read = true;
          renderNotifications();
        }
      }

      function markAllAsRead() {
        notifications.forEach((n) => (n.read = true));
        renderNotifications();
      }

      document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("notificationDropdown");
        const panel = document.getElementById("notificationPanel");
        if (
          !dropdown.contains(e.target) &&
          !panel.classList.contains("hidden")
        ) {
          panel.classList.add("hidden");
        }
      });

      // Initialize on load
      document.addEventListener("DOMContentLoaded", function () {
        loadNotifications();
      });
    </script>
    <script type="module" src="/src/scripts/main.js"></script>
  </body>
</html>
