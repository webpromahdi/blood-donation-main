<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Announcements - BloodConnect Admin</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
  </head>

  <body class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div
      class="w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 flex flex-col"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="bg-red-600 p-2 rounded-lg">
            <i data-lucide="heart" class="size-6 text-white fill-white"></i>
          </div>
          <div>
            <div class="font-semibold text-red-600">BloodConnect</div>
            <div class="text-sm text-gray-500">Admin Panel</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <a
          href="/src/pages/admin/dashboard.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="layout-dashboard" class="size-5"></i
          ><span>Dashboard</span></a
        >
        <a
          href="/src/pages/admin/donors.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="users" class="size-5"></i><span>Donors</span></a
        >
        <a
          href="/src/pages/admin/hospitals.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="building-2" class="size-5"></i
          ><span>Hospitals</span></a
        >
        <a
          href="/src/pages/admin/voluntary.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="hand-heart" class="size-5"></i
          ><span>Voluntary Donations</span></a
        >
        <a
          href="/src/pages/admin/blood-groups.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="droplet" class="size-5"></i
          ><span>Blood Groups</span></a
        >
        <a
          href="/src/pages/admin/reports.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="file-text" class="size-5"></i><span>Reports</span></a
        >
        <a
          href="/src/pages/admin/announcements.html"
          class="flex items-center gap-3 px-6 py-3 text-red-600 bg-red-50 border-r-4 border-red-600"
          ><i data-lucide="megaphone" class="size-5"></i
          ><span>Announcements</span></a
        >
        <a
          href="/src/pages/admin/chat.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="message-square" class="size-5"></i
          ><span>Chat</span></a
        >
      </nav>
      <div class="p-4 border-t border-gray-200">
        <div class="text-center text-sm text-gray-500">
          <p>Emergency: <span class="text-red-600 font-semibold">911</span></p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="h-16 bg-white border-b border-gray-200 fixed top-0 left-64 right-0 z-10 flex items-center justify-between px-8"
    >
      <div class="flex items-center gap-4 flex-1">
        <h2 class="text-lg font-semibold text-gray-900">Announcements</h2>
      </div>
      <div class="flex items-center gap-4">
        <!-- Notification Dropdown -->
        <div class="relative" id="notificationDropdown">
          <button
            class="relative p-2 hover:bg-gray-100 rounded-lg transition-colors"
            onclick="toggleNotifications()"
            id="notificationBell"
          >
            <i data-lucide="bell" class="size-5 text-gray-700"></i>
            <span
              class="absolute -top-1 -right-1 size-5 flex items-center justify-center p-0 bg-red-600 text-white text-xs rounded-full"
              id="notificationBadge"
              >4</span
            >
          </button>

          <!-- Notification Panel -->
          <div
            id="notificationPanel"
            class="hidden absolute right-0 top-12 w-80 bg-white border border-gray-200 rounded-xl shadow-xl z-50"
          >
            <div
              class="p-4 border-b border-gray-200 flex items-center justify-between"
            >
              <h3 class="font-semibold text-gray-900">Notifications</h3>
              <button
                onclick="markAllAsRead()"
                class="text-xs text-red-600 hover:text-red-700 font-medium"
              >
                Mark all as read
              </button>
            </div>
            <div class="max-h-80 overflow-y-auto" id="notificationList">
              <!-- Notifications will be populated by JS -->
            </div>
            <div class="p-3 border-t border-gray-200 text-center">
              <a
                href="/src/pages/admin/notifications.html"
                class="text-sm text-red-600 hover:text-red-700 font-medium"
              >
                View all notifications
              </a>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
          <div class="text-right">
            <div class="text-sm font-medium text-gray-900">Admin User</div>
            <div class="text-xs text-gray-500">System Administrator</div>
          </div>
          <div
            class="size-10 bg-red-100 rounded-full flex items-center justify-center"
          >
            <i data-lucide="user" class="size-5 text-red-600"></i>
          </div>
        </div>
        <a href="/" class="p-2 text-gray-600 hover:text-red-600"
          ><i data-lucide="log-out" class="size-5"></i
        ></a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="ml-64 pt-16">
      <div class="p-8 space-y-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">Announcements</h1>
            <p class="text-gray-600">Create and manage system announcements</p>
          </div>
          <button
            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium"
          >
            <i data-lucide="plus" class="size-4 inline mr-2"></i>New
            Announcement
          </button>
        </div>

        <!-- Create Announcement Form -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">
              Create New Announcement
            </h2>
            <p class="text-sm text-gray-600">
              Broadcast important updates to all users
            </p>
          </div>
          <form id="announcementForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Title</label
              >
              <input
                type="text"
                id="announcementTitle"
                placeholder="Announcement title..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Message</label
              >
              <textarea
                rows="4"
                id="announcementMessage"
                placeholder="Write your announcement message..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              ></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Target Audience</label
                >
                <select
                  id="announcementAudience"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                >
                  <option value="all">All Users</option>
                  <option value="donors">Donors Only</option>
                  <option value="hospitals">Hospitals Only</option>
                  <option value="seekers">Seekers Only</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Priority</label
                >
                <select
                  id="announcementPriority"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                >
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Schedule</label
                >
                <input
                  type="datetime-local"
                  id="announcementSchedule"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                />
              </div>
            </div>
            <div class="flex gap-3">
              <button
                type="submit"
                id="publishBtn"
                class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium disabled:opacity-50"
              >
                <i data-lucide="send" class="size-4 inline mr-2"></i>Publish Now
              </button>
              <button
                type="button"
                id="scheduleBtn"
                class="px-6 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium"
              >
                <i data-lucide="clock" class="size-4 inline mr-2"></i>Schedule
              </button>
            </div>
          </form>
        </div>

        <!-- Existing Announcements -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">
              Recent Announcements
            </h2>
            <p class="text-sm text-gray-600">
              Manage published and scheduled announcements
            </p>
          </div>
          <div class="space-y-4" id="announcementsContainer">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
              <div
                class="size-12 border-4 border-gray-200 border-t-red-600 rounded-full animate-spin mx-auto mb-4"
              ></div>
              <p class="text-gray-500">Loading announcements...</p>
            </div>
            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
              <div
                class="size-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"
              >
                <i data-lucide="megaphone" class="size-8 text-gray-400"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-2">
                No Announcements
              </h3>
              <p class="text-gray-500">
                Create your first announcement using the form above
              </p>
            </div>
            <!-- Announcements List -->
            <div id="announcementsList" class="hidden space-y-4"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Announcements System -->
    <script>
      const API_URL = "/api/admin/announcements.php";

      // DOM Elements
      const form = document.getElementById("announcementForm");
      const loadingState = document.getElementById("loadingState");
      const emptyState = document.getElementById("emptyState");
      const announcementsList = document.getElementById("announcementsList");
      const publishBtn = document.getElementById("publishBtn");
      const scheduleBtn = document.getElementById("scheduleBtn");

      // Load announcements on page load
      document.addEventListener("DOMContentLoaded", loadAnnouncements);

      // Form submission for "Publish Now"
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        await createAnnouncement(false);
      });

      // Schedule button handler
      scheduleBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        await createAnnouncement(true);
      });

      /**
       * Create announcement - handles both publish now and schedule
       * @param {boolean} isScheduled - Whether to schedule or publish immediately
       */
      async function createAnnouncement(isScheduled) {
        const title = document.getElementById("announcementTitle").value.trim();
        const message = document
          .getElementById("announcementMessage")
          .value.trim();
        const target_audience = document.getElementById(
          "announcementAudience",
        ).value;
        const priority = document.getElementById("announcementPriority").value;
        const scheduleInput = document.getElementById(
          "announcementSchedule",
        ).value;

        // Validation
        if (!title || !message) {
          showNotification("Please fill in title and message", "error");
          return;
        }

        // For scheduled announcements, require a future date/time
        let scheduled_at = null;
        if (isScheduled) {
          if (!scheduleInput) {
            showNotification("Please select a schedule date and time", "error");
            return;
          }

          const scheduleDate = new Date(scheduleInput);
          const now = new Date();

          if (scheduleDate <= now) {
            showNotification("Schedule time must be in the future", "error");
            return;
          }

          // Convert to MySQL datetime format
          scheduled_at = scheduleInput.replace("T", " ") + ":00";
        }

        // Update button state
        const btn = isScheduled ? scheduleBtn : publishBtn;
        const originalBtnHtml = btn.innerHTML;
        btn.disabled = true;
        scheduleBtn.disabled = true;
        publishBtn.disabled = true;
        btn.innerHTML = `<i data-lucide="loader-2" class="size-4 inline mr-2 animate-spin"></i>${isScheduled ? "Scheduling..." : "Publishing..."}`;
        if (window.lucide) lucide.createIcons();

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title,
              message,
              target_audience,
              priority,
              scheduled_at,
            }),
          });

          const data = await res.json();

          if (data.success) {
            form.reset();
            showNotification(
              isScheduled
                ? `Announcement scheduled for ${formatDateTime(scheduleInput)}`
                : "Announcement published successfully",
              "success",
            );
            loadAnnouncements();
          } else {
            showNotification(
              data.message || "Failed to create announcement",
              "error",
            );
          }
        } catch (err) {
          console.error("Error:", err);
          showNotification(
            "Failed to create announcement. Please try again.",
            "error",
          );
        } finally {
          publishBtn.disabled = false;
          scheduleBtn.disabled = false;
          publishBtn.innerHTML =
            '<i data-lucide="send" class="size-4 inline mr-2"></i>Publish Now';
          scheduleBtn.innerHTML =
            '<i data-lucide="clock" class="size-4 inline mr-2"></i>Schedule';
          if (window.lucide) lucide.createIcons();
        }
      }

      /**
       * Show notification toast
       */
      function showNotification(message, type = "info") {
        // Remove any existing notification
        const existing = document.getElementById("toast-notification");
        if (existing) existing.remove();

        const colors = {
          success: "bg-green-600",
          error: "bg-red-600",
          info: "bg-blue-600",
        };

        const icons = {
          success: "check-circle",
          error: "x-circle",
          info: "info",
        };

        const toast = document.createElement("div");
        toast.id = "toast-notification";
        toast.className = `fixed top-20 right-8 z-50 flex items-center gap-3 px-4 py-3 ${colors[type]} text-white rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
        toast.innerHTML = `
        <i data-lucide="${icons[type]}" class="size-5"></i>
        <span class="font-medium">${message}</span>
      `;

        document.body.appendChild(toast);
        if (window.lucide) lucide.createIcons();

        // Animate in
        setTimeout(() => toast.classList.remove("translate-x-full"), 10);

        // Auto remove after 4 seconds
        setTimeout(() => {
          toast.classList.add("translate-x-full");
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      // Fetch and render announcements
      async function loadAnnouncements() {
        showLoading();

        try {
          const res = await fetch(API_URL);
          const data = await res.json();

          if (data.success && data.announcements.length > 0) {
            renderAnnouncements(data.announcements);
          } else {
            showEmpty();
          }
        } catch (err) {
          console.error("Error:", err);
          showEmpty();
        }
      }

      function showLoading() {
        loadingState.classList.remove("hidden");
        emptyState.classList.add("hidden");
        announcementsList.classList.add("hidden");
      }

      function showEmpty() {
        loadingState.classList.add("hidden");
        emptyState.classList.remove("hidden");
        announcementsList.classList.add("hidden");
        if (window.lucide) lucide.createIcons();
      }

      function renderAnnouncements(announcements) {
        loadingState.classList.add("hidden");
        emptyState.classList.add("hidden");
        announcementsList.classList.remove("hidden");

        const priorityColors = {
          urgent: "bg-red-100 text-red-700",
          high: "bg-orange-100 text-orange-700",
          normal: "bg-blue-100 text-blue-700",
        };

        const statusConfig = {
          published: {
            bg: "bg-green-100",
            text: "text-green-700",
            label: "Live",
            icon: "radio",
          },
          scheduled: {
            bg: "bg-yellow-100",
            text: "text-yellow-700",
            label: "Scheduled",
            icon: "clock",
          },
          draft: {
            bg: "bg-gray-100",
            text: "text-gray-700",
            label: "Draft",
            icon: "file-edit",
          },
          archived: {
            bg: "bg-gray-100",
            text: "text-gray-500",
            label: "Archived",
            icon: "archive",
          },
        };

        const audienceLabels = {
          all: "All Users",
          donors: "Donors",
          hospitals: "Hospitals",
          seekers: "Seekers",
        };

        announcementsList.innerHTML = announcements
          .map((a) => {
            const status = statusConfig[a.status] || statusConfig.published;
            const scheduledInfo =
              a.is_scheduled && a.scheduled_at
                ? `<span class="text-yellow-600"><i data-lucide="clock" class="size-3 inline mr-1"></i>Scheduled: ${formatDateTime(a.scheduled_at)}</span>`
                : "";

            return `
        <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow ${a.status === "archived" ? "opacity-60" : ""}">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2 flex-wrap">
                <h3 class="font-semibold text-gray-900">${escapeHtml(a.title)}</h3>
                <span class="px-2 py-0.5 text-xs font-medium rounded-full ${status.bg} ${status.text}">
                  <i data-lucide="${status.icon}" class="size-3 inline mr-1"></i>${status.label}
                </span>
                <span class="px-2 py-0.5 text-xs font-medium rounded-full ${priorityColors[a.priority] || priorityColors.normal}">
                  ${a.priority.charAt(0).toUpperCase() + a.priority.slice(1)}
                </span>
              </div>
              <p class="text-gray-600 text-sm mb-3 line-clamp-2">${escapeHtml(a.message)}</p>
              <div class="flex items-center gap-4 text-xs text-gray-500 flex-wrap">
                <span><i data-lucide="users" class="size-3 inline mr-1"></i>${audienceLabels[a.target_audience] || "All Users"}</span>
                <span><i data-lucide="calendar" class="size-3 inline mr-1"></i>Created: ${formatDate(a.created_at)}</span>
                <span><i data-lucide="user" class="size-3 inline mr-1"></i>${escapeHtml(a.admin_name)}</span>
                ${scheduledInfo}
              </div>
            </div>
            <button onclick="deleteAnnouncement(${a.id})" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
              <i data-lucide="trash-2" class="size-4"></i>
            </button>
          </div>
        </div>
      `;
          })
          .join("");

        if (window.lucide) lucide.createIcons();
      }

      async function deleteAnnouncement(id) {
        if (!confirm("Are you sure you want to delete this announcement?"))
          return;

        try {
          const res = await fetch(`${API_URL}?id=${id}`, { method: "DELETE" });
          const data = await res.json();

          if (data.success) {
            showNotification("Announcement deleted successfully", "success");
            loadAnnouncements();
          } else {
            showNotification(
              data.message || "Failed to delete announcement",
              "error",
            );
          }
        } catch (err) {
          console.error("Error:", err);
          showNotification("Failed to delete announcement", "error");
        }
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
    <script type="module" src="/src/scripts/main.js"></script>
    <script type="module">
      import { initNotificationDropdown } from "/src/scripts/components/notification-dropdown.js";
      initNotificationDropdown("admin");
    </script>
  </body>
</html>
