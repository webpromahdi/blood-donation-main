<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Donate Voluntarily - BloodConnect Donor</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
  </head>

  <body class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div
      class="w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 flex flex-col"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="bg-red-600 p-2 rounded-lg">
            <i data-lucide="heart" class="size-6 text-white fill-white"></i>
          </div>
          <div>
            <div class="font-semibold text-red-600">BloodConnect</div>
            <div class="text-sm text-gray-500">Donor Portal</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <a
          href="/src/pages/donor/dashboard.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="layout-dashboard" class="size-5"></i
          ><span>Dashboard</span></a
        >
        <a
          href="/src/pages/donor/health.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="heart" class="size-5"></i><span>Health Info</span></a
        >
        <a
          href="/src/pages/donor/voluntary.html"
          class="flex items-center gap-3 px-6 py-3 text-red-600 bg-red-50 border-r-4 border-red-600"
          ><i data-lucide="calendar" class="size-5"></i
          ><span>Donate Voluntarily</span></a
        >
        <a
          href="/src/pages/donor/history.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="file-text" class="size-5"></i
          ><span>Donation History</span></a
        >
        <a
          href="/src/pages/donor/certificates.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="award" class="size-5"></i
          ><span>Certificates</span></a
        >
        <a
          href="/src/pages/donor/chat.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="message-square" class="size-5"></i
          ><span>Chat</span></a
        >
      </nav>
      <div class="p-4 border-t border-gray-200">
        <div class="text-center text-sm text-gray-500">
          <p>Emergency: <span class="text-red-600 font-semibold">911</span></p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="h-16 bg-white border-b border-gray-200 fixed top-0 left-64 right-0 z-10 flex items-center justify-between px-8"
    >
      <div class="flex items-center gap-4 flex-1">
        <h2 class="text-lg font-semibold text-gray-900">Donate Voluntarily</h2>
      </div>
      <div class="flex items-center gap-4">
        <button class="relative p-2 hover:bg-gray-100 rounded-lg">
          <i data-lucide="bell" class="size-5 text-gray-700"></i>
        </button>
        <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
          <div class="text-right">
            <div class="text-sm font-medium text-gray-900" data-user-name>
              John Smith
            </div>
            <div class="text-xs text-gray-500" data-user-role>Blood Donor</div>
          </div>
          <div
            class="size-10 bg-green-100 rounded-full flex items-center justify-center"
          >
            <i data-lucide="user" class="size-5 text-green-600"></i>
          </div>
        </div>
        <a href="/" class="p-2 text-gray-600 hover:text-red-600"
          ><i data-lucide="log-out" class="size-5"></i
        ></a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="ml-64 pt-16">
      <!-- Pending Approval Message (Hidden by default) -->
      <div id="pendingApprovalMessage" class="hidden p-8">
        <div class="max-w-2xl mx-auto mt-16">
          <div
            class="p-8 bg-white border border-gray-200 rounded-xl text-center"
          >
            <div
              class="bg-yellow-100 p-4 rounded-full w-20 h-20 mx-auto mb-6 flex items-center justify-center"
            >
              <i data-lucide="clock" class="size-10 text-yellow-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
              Account Under Review
            </h2>
            <p class="text-gray-600 mb-6">
              Your account is currently pending approval. Please wait for admin
              review before you can access the full dashboard and start donating
              blood.
            </p>
            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p class="text-sm text-yellow-800">
                <i data-lucide="info" class="size-4 inline mr-1"></i>This
                usually takes 24-48 hours. You will be notified once your
                account is approved.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Content (Shown when approved) -->
      <div id="dashboardContent" class="p-8 space-y-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 mb-2">
            Donate Voluntarily
          </h1>
          <p class="text-gray-600">
            Schedule a voluntary blood donation at your preferred hospital
          </p>
        </div>

        <!-- Select Hospital -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">
              Select Hospital
            </h2>
            <p class="text-sm text-gray-600 mb-4">
              Choose a hospital near you for your donation
            </p>
            <div class="relative">
              <i
                data-lucide="search"
                class="absolute left-3 top-1/2 -translate-y-1/2 size-5 text-gray-400"
              ></i>
              <input
                type="text"
                id="hospitalSearch"
                placeholder="Search hospitals by name or location..."
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              />
            </div>
          </div>
          <div class="space-y-3 max-h-96 overflow-y-auto" id="hospitalList">
            <!-- Loading state -->
            <div class="text-center py-8" id="hospitalLoading">
              <i
                data-lucide="loader"
                class="size-8 text-gray-400 mx-auto mb-3 animate-spin"
              ></i>
              <p class="text-gray-500">Loading hospitals...</p>
            </div>
          </div>
          <!-- Empty State -->
          <div id="hospitalEmptyState" class="hidden text-center py-12">
            <div
              class="inline-flex items-center justify-center size-16 rounded-full bg-gray-100 mb-4"
            >
              <i data-lucide="building-2" class="size-8 text-gray-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">
              No Hospitals Available
            </h3>
            <p class="text-gray-600">
              No hospitals are currently accepting voluntary donations in your
              area.
            </p>
          </div>
        </div>

        <!-- Choose Date & Time -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl">
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">
              Choose Date & Time
            </h2>
            <p class="text-sm text-gray-600">
              Select your preferred date and time slot
            </p>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Select Date</label
              >
              <input
                type="date"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Select Time Slot</label
              >
              <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto p-2">
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  08:00 AM
                </button>
                <button
                  class="px-4 py-2 border border-red-600 bg-red-50 text-red-600 rounded-lg text-sm"
                >
                  09:00 AM
                </button>
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  10:00 AM
                </button>
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  11:00 AM
                </button>
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  12:00 PM
                </button>
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  01:00 PM
                </button>
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  02:00 PM
                </button>
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  03:00 PM
                </button>
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  04:00 PM
                </button>
                <button
                  class="px-4 py-2 border border-gray-300 hover:border-red-600 hover:bg-red-50 rounded-lg text-sm"
                >
                  05:00 PM
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary & Submit -->
        <div
          class="p-6 bg-linear-to-r from-red-50 to-white border border-red-200 rounded-xl"
        >
          <h2 class="text-lg font-semibold text-gray-900 mb-4">
            Booking Summary
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="p-4 bg-white rounded-lg border border-gray-200">
              <div class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <i data-lucide="building-2" class="size-4"></i
                ><span>Hospital</span>
              </div>
              <p class="font-medium text-gray-900" id="selectedHospitalName">
                Select a hospital
              </p>
            </div>
            <div class="p-4 bg-white rounded-lg border border-gray-200">
              <div class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <i data-lucide="calendar" class="size-4"></i><span>Date</span>
              </div>
              <p class="font-medium text-gray-900" id="selectedDate">
                Select a date
              </p>
            </div>
            <div class="p-4 bg-white rounded-lg border border-gray-200">
              <div class="flex items-center gap-2 text-sm text-gray-600 mb-1">
                <i data-lucide="clock" class="size-4"></i><span>Time</span>
              </div>
              <p class="font-medium text-gray-900" id="selectedTime">
                Select a time
              </p>
            </div>
          </div>
          <button
            id="submitDonationBtn"
            class="w-full px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
            disabled
          >
            <i data-lucide="check-circle" class="size-4 inline mr-2"></i>Submit
            Donation Request
          </button>
        </div>
      </div>
    </main>

    <script type="module" src="/src/scripts/main.js"></script>
    <script type="module">
      import { initUserLoader } from "/src/scripts/user-loader.js";
      initUserLoader();

      // Account status check
      async function checkAccountStatus() {
        try {
          const response = await fetch("/api/auth/check.php");
          const data = await response.json();

          if (!data.success || !data.logged_in) {
            window.location.href = "/src/pages/auth/login.html";
            return false;
          }

          const status = data.user.status || "pending";
          const dashboardContent = document.getElementById("dashboardContent");
          const pendingMessage = document.getElementById(
            "pendingApprovalMessage",
          );

          // Handle rejected status - logout and redirect to login
          if (status === "rejected") {
            await fetch("/api/auth/logout.php", { method: "POST" });
            window.location.href = "/src/pages/auth/login.html?error=rejected";
            return false;
          }

          if (status !== "approved") {
            if (dashboardContent) dashboardContent.classList.add("hidden");
            if (pendingMessage) {
              pendingMessage.classList.remove("hidden");
              if (window.lucide) window.lucide.createIcons();
            }
            return false;
          }

          if (dashboardContent) dashboardContent.classList.remove("hidden");
          if (pendingMessage) pendingMessage.classList.add("hidden");
          return true;
        } catch (error) {
          console.error("Failed to check account status:", error);
          return false;
        }
      }

      let selectedHospital = null;
      let selectedDate = null;
      let selectedTime = null;
      let hospitals = [];

      // Load hospitals from API
      async function loadHospitals() {
        const hospitalList = document.getElementById("hospitalList");
        const hospitalLoading = document.getElementById("hospitalLoading");
        const hospitalEmptyState =
          document.getElementById("hospitalEmptyState");

        try {
          const response = await fetch("/api/donor/requests.php", {
            credentials: "include",
          });
          const data = await response.json();

          if (hospitalLoading) hospitalLoading.classList.add("hidden");

          // Since there's no dedicated hospitals endpoint for donors,
          // show the empty state with guidance
          if (!data.success || !data.hospitals || data.hospitals.length === 0) {
            if (hospitalEmptyState)
              hospitalEmptyState.classList.remove("hidden");
            if (hospitalList) hospitalList.innerHTML = "";
            return;
          }

          hospitals = data.hospitals;
          renderHospitals(hospitals);
        } catch (error) {
          console.error("Error loading hospitals:", error);
          if (hospitalLoading) hospitalLoading.classList.add("hidden");
          if (hospitalEmptyState) hospitalEmptyState.classList.remove("hidden");
        }
      }

      function renderHospitals(hospitalsToRender) {
        const hospitalList = document.getElementById("hospitalList");
        const hospitalEmptyState =
          document.getElementById("hospitalEmptyState");

        if (!hospitalsToRender || hospitalsToRender.length === 0) {
          if (hospitalEmptyState) hospitalEmptyState.classList.remove("hidden");
          if (hospitalList) hospitalList.innerHTML = "";
          return;
        }

        if (hospitalEmptyState) hospitalEmptyState.classList.add("hidden");
        hospitalList.innerHTML = hospitalsToRender
          .map((hospital) => {
            const isSelected =
              selectedHospital && selectedHospital.id === hospital.id;
            return `
            <div class="hospital-item p-4 border ${
              isSelected
                ? "border-red-600 bg-red-50"
                : "border-gray-200 hover:border-red-300 hover:shadow-md"
            } rounded-lg cursor-pointer transition-all" data-id="${
              hospital.id
            }">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="size-10 ${
                    isSelected ? "bg-red-600" : "bg-gray-100"
                  } rounded-full flex items-center justify-center">
                    <i data-lucide="heart" class="size-5 ${
                      isSelected ? "text-white" : "text-gray-600"
                    }"></i>
                  </div>
                  <div>
                    <h3 class="font-medium text-gray-900">${hospital.name}</h3>
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                      <i data-lucide="map-pin" class="size-4"></i><span>${
                        hospital.city || "Location not specified"
                      }</span>
                    </div>
                  </div>
                </div>
                ${
                  isSelected
                    ? '<i data-lucide="check-circle" class="size-6 text-red-600"></i>'
                    : ""
                }
              </div>
            </div>
          `;
          })
          .join("");

        // Attach click handlers
        document.querySelectorAll(".hospital-item").forEach((item) => {
          item.addEventListener("click", () => selectHospital(item.dataset.id));
        });

        if (window.lucide) window.lucide.createIcons();
      }

      function selectHospital(hospitalId) {
        selectedHospital = hospitals.find((h) => h.id == hospitalId);
        document.getElementById("selectedHospitalName").textContent =
          selectedHospital ? selectedHospital.name : "Select a hospital";
        renderHospitals(hospitals);
        updateSubmitButton();
      }

      // Search functionality
      const searchInput = document.getElementById("hospitalSearch");
      if (searchInput) {
        searchInput.addEventListener("input", (e) => {
          const query = e.target.value.toLowerCase();
          const filtered = hospitals.filter(
            (h) =>
              h.name.toLowerCase().includes(query) ||
              (h.city && h.city.toLowerCase().includes(query)),
          );
          renderHospitals(filtered);
        });
      }

      // Date selection
      const dateInput = document.querySelector('input[type="date"]');
      if (dateInput) {
        dateInput.addEventListener("change", (e) => {
          selectedDate = e.target.value;
          if (selectedDate) {
            const dateObj = new Date(selectedDate);
            document.getElementById("selectedDate").textContent =
              dateObj.toLocaleDateString("en-US", {
                weekday: "short",
                year: "numeric",
                month: "short",
                day: "numeric",
              });
          }
          updateSubmitButton();
        });
      }

      // Time slot selection
      document
        .querySelectorAll(".grid.grid-cols-2.gap-2 button")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".grid.grid-cols-2.gap-2 button")
              .forEach((b) => {
                b.classList.remove(
                  "border-red-600",
                  "bg-red-50",
                  "text-red-600",
                );
                b.classList.add("border-gray-300");
              });
            btn.classList.remove("border-gray-300");
            btn.classList.add("border-red-600", "bg-red-50", "text-red-600");
            selectedTime = btn.textContent.trim();
            document.getElementById("selectedTime").textContent = selectedTime;
            updateSubmitButton();
          });
        });

      function updateSubmitButton() {
        const btn = document.getElementById("submitDonationBtn");
        if (btn)
          btn.disabled = !(selectedHospital && selectedDate && selectedTime);
      }

      // Submit donation request
      const submitBtn = document.getElementById("submitDonationBtn");
      if (submitBtn) {
        submitBtn.addEventListener("click", async () => {
          if (!selectedHospital || !selectedDate || !selectedTime) return;

          // Show success notification (actual submission would go to an API)
          const notification = document.createElement("div");
          notification.className =
            "fixed top-20 right-8 p-4 bg-green-50 border-l-4 border-green-600 rounded-lg shadow-lg z-50";
          notification.innerHTML = `
            <div class="flex items-center gap-3">
              <i data-lucide="check-circle" class="size-5 text-green-600"></i>
              <p class="text-green-900">Donation request submitted successfully! The hospital will contact you to confirm.</p>
            </div>
          `;
          document.body.appendChild(notification);
          if (window.lucide) window.lucide.createIcons();
          setTimeout(() => notification.remove(), 5000);
        });
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        checkAccountStatus().then((isApproved) => {
          if (isApproved) {
            loadHospitals();
          }
        });
      });
    </script>
  </body>
</html>
