<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Health Info - BloodConnect Donor</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
  </head>

  <body class="min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <div
      class="w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 flex flex-col"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="bg-red-600 p-2 rounded-lg">
            <i data-lucide="heart" class="size-6 text-white fill-white"></i>
          </div>
          <div>
            <div class="font-semibold text-red-600">BloodConnect</div>
            <div class="text-sm text-gray-500">Donor Portal</div>
          </div>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <a
          href="/src/pages/donor/dashboard.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="layout-dashboard" class="size-5"></i
          ><span>Dashboard</span></a
        >
        <a
          href="/src/pages/donor/health.html"
          class="flex items-center gap-3 px-6 py-3 text-red-600 bg-red-50 border-r-4 border-red-600"
          ><i data-lucide="heart" class="size-5"></i><span>Health Info</span></a
        >
        <a
          href="/src/pages/donor/voluntary.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="calendar" class="size-5"></i
          ><span>Donate Voluntarily</span></a
        >
        <a
          href="/src/pages/donor/history.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="file-text" class="size-5"></i
          ><span>Donation History</span></a
        >
        <a
          href="/src/pages/donor/certificates.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="award" class="size-5"></i
          ><span>Certificates</span></a
        >
        <a
          href="/src/pages/donor/chat.html"
          class="flex items-center gap-3 px-6 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600"
          ><i data-lucide="message-square" class="size-5"></i
          ><span>Chat</span></a
        >
      </nav>
      <div class="p-4 border-t border-gray-200">
        <div class="text-center text-sm text-gray-500">
          <p>Emergency: <span class="text-red-600 font-semibold">911</span></p>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="h-16 bg-white border-b border-gray-200 fixed top-0 left-64 right-0 z-10 flex items-center justify-between px-8"
    >
      <div class="flex items-center gap-4 flex-1">
        <h2 class="text-lg font-semibold text-gray-900">Health Information</h2>
      </div>
      <div class="flex items-center gap-4">
        <button class="relative p-2 hover:bg-gray-100 rounded-lg">
          <i data-lucide="bell" class="size-5 text-gray-700"></i>
        </button>
        <div class="flex items-center gap-3 pl-4 border-l border-gray-200">
          <div class="text-right">
            <div class="text-sm font-medium text-gray-900" data-user-name>
              John Smith
            </div>
            <div class="text-xs text-gray-500" data-user-role>Blood Donor</div>
          </div>
          <div
            class="size-10 bg-green-100 rounded-full flex items-center justify-center"
          >
            <i data-lucide="user" class="size-5 text-green-600"></i>
          </div>
        </div>
        <a href="/" class="p-2 text-gray-600 hover:text-red-600"
          ><i data-lucide="log-out" class="size-5"></i
        ></a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="ml-64 pt-16">
      <!-- Pending Approval Message (Hidden by default) -->
      <div id="pendingApprovalMessage" class="hidden p-8">
        <div class="max-w-2xl mx-auto mt-16">
          <div
            class="p-8 bg-white border border-gray-200 rounded-xl text-center"
          >
            <div
              class="bg-yellow-100 p-4 rounded-full w-20 h-20 mx-auto mb-6 flex items-center justify-center"
            >
              <i data-lucide="clock" class="size-10 text-yellow-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">
              Account Under Review
            </h2>
            <p class="text-gray-600 mb-6">
              Your account is currently pending approval. Please wait for admin
              review before you can access the full dashboard and start donating
              blood.
            </p>
            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p class="text-sm text-yellow-800">
                <i data-lucide="info" class="size-4 inline mr-1"></i>This
                usually takes 24-48 hours. You will be notified once your
                account is approved.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Content (Shown when approved) -->
      <div id="dashboardContent" class="p-8 space-y-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900 mb-2">
            Health Information
          </h1>
          <p class="text-gray-600">
            Keep your health information up to date for safe donations
          </p>
        </div>

        <!-- Health Record Status Banner -->
        <div id="healthRecordBanner" class="hidden">
          <!-- New Record Banner -->
          <div
            id="newRecordBanner"
            class="hidden p-4 bg-blue-50 border border-blue-200 rounded-xl"
          >
            <div class="flex items-start gap-3">
              <i
                data-lucide="info"
                class="size-5 text-blue-600 shrink-0 mt-0.5"
              ></i>
              <div>
                <p class="font-medium text-blue-900">
                  Complete Your Health Profile
                </p>
                <p class="text-sm text-blue-700 mt-1">
                  Please fill in your health information. Weight and Height are
                  required for your first submission.
                </p>
              </div>
            </div>
          </div>
          <!-- Existing Record Banner -->
          <div
            id="existingRecordBanner"
            class="hidden p-4 bg-green-50 border border-green-200 rounded-xl"
          >
            <div class="flex items-start gap-3">
              <i
                data-lucide="check-circle"
                class="size-5 text-green-600 shrink-0 mt-0.5"
              ></i>
              <div>
                <p class="font-medium text-green-900">
                  Your Health Information is on File
                </p>
                <p class="text-sm text-green-700 mt-1">
                  Update any fields you need to change. Empty fields will keep
                  their current values.
                </p>
                <p class="text-sm text-green-600 mt-2" id="lastUpdatedText"></p>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Main Form -->
          <div class="lg:col-span-2">
            <div class="p-6 bg-white border border-gray-200 rounded-xl">
              <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-1">
                  Personal Health Details
                </h2>
                <p class="text-sm text-gray-600">
                  Please provide accurate health information
                </p>
              </div>

              <form id="healthForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 mb-2"
                      for="weight"
                      >Weight (kg) *</label
                    >
                    <input
                      type="number"
                      id="weight"
                      name="weight"
                      placeholder="Your weight"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                    <p
                      class="text-red-500 text-sm mt-1 hidden"
                      id="weightError"
                    ></p>
                  </div>
                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 mb-2"
                      for="height"
                      >Height (cm) *</label
                    >
                    <input
                      type="number"
                      id="height"
                      name="height"
                      placeholder="Your height"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                    <p
                      class="text-red-500 text-sm mt-1 hidden"
                      id="heightError"
                    ></p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Blood Pressure (Systolic)</label
                    >
                    <input
                      type="number"
                      id="bpSystolic"
                      placeholder="e.g., 120"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Blood Pressure (Diastolic)</label
                    >
                    <input
                      type="number"
                      id="bpDiastolic"
                      placeholder="e.g., 80"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Hemoglobin Level</label
                    >
                    <input
                      type="text"
                      id="hemoglobin"
                      placeholder="e.g., 14.5 g/dL"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Last Medical Checkup</label
                    >
                    <input
                      type="date"
                      id="lastCheckup"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                  </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                  <h3 class="font-semibold text-gray-900 mb-4">
                    Medical Conditions
                  </h3>
                  <p class="text-sm text-gray-600 mb-4">
                    Please indicate if you have any of the following conditions:
                  </p>
                  <div class="space-y-3">
                    <div
                      class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"
                    >
                      <label class="cursor-pointer" for="hasDiabetes"
                        >Diabetes</label
                      >
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          id="hasDiabetes"
                          class="sr-only peer"
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"
                        ></div>
                      </label>
                    </div>
                    <div
                      class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"
                    >
                      <label class="cursor-pointer" for="hasHypertension"
                        >Hypertension</label
                      >
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          id="hasHypertension"
                          class="sr-only peer"
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"
                        ></div>
                      </label>
                    </div>
                    <div
                      class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"
                    >
                      <label class="cursor-pointer" for="hasHeartDisease"
                        >Heart Disease</label
                      >
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          id="hasHeartDisease"
                          class="sr-only peer"
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"
                        ></div>
                      </label>
                    </div>
                    <div
                      class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"
                    >
                      <label class="cursor-pointer" for="hasAsthma"
                        >Asthma</label
                      >
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          id="hasAsthma"
                          class="sr-only peer"
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"
                        ></div>
                      </label>
                    </div>
                    <div
                      class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"
                    >
                      <label class="cursor-pointer" for="hasAllergies"
                        >Allergies</label
                      >
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          id="hasAllergies"
                          class="sr-only peer"
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"
                        ></div>
                      </label>
                    </div>
                    <div
                      class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"
                    >
                      <label class="cursor-pointer" for="hasRecentSurgery"
                        >Recent Surgery (within 6 months)</label
                      >
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          id="hasRecentSurgery"
                          class="sr-only peer"
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"
                        ></div>
                      </label>
                    </div>
                    <div
                      class="flex items-center justify-between p-3 border border-gray-200 rounded-lg"
                    >
                      <label class="cursor-pointer" for="isOnMedication"
                        >Currently on Medication</label
                      >
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          id="isOnMedication"
                          class="sr-only peer"
                        />
                        <div
                          class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"
                        ></div>
                      </label>
                    </div>
                  </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                  <h3 class="font-semibold text-gray-900 mb-4">
                    Lifestyle Information
                  </h3>
                  <div class="space-y-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        for="smokingStatus"
                        >Do you smoke?</label
                      >
                      <select
                        id="smokingStatus"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                      >
                        <option value="no">No</option>
                        <option value="occasionally">Yes, occasionally</option>
                        <option value="regularly">Yes, regularly</option>
                      </select>
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        for="alcoholConsumption"
                        >Alcohol Consumption</label
                      >
                      <select
                        id="alcoholConsumption"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                      >
                        <option value="none">None</option>
                        <option value="occasionally">Occasional</option>
                        <option value="regularly">Regular</option>
                      </select>
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        for="exerciseFrequency"
                        >Exercise Frequency</label
                      >
                      <select
                        id="exerciseFrequency"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
                      >
                        <option value="rarely">Rarely</option>
                        <option value="weekly">1-2 times per week</option>
                        <option value="daily">Daily</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                  <h3 class="font-semibold text-gray-900 mb-4">
                    Additional Notes
                  </h3>
                  <p class="text-sm text-gray-600 mb-4">
                    Any other health information or concerns you'd like to share
                    with medical staff
                  </p>
                  <div>
                    <label
                      class="block text-sm font-medium text-gray-700 mb-2"
                      for="additionalNotes"
                      >Extra Notes (Optional)</label
                    >
                    <textarea
                      id="additionalNotes"
                      rows="4"
                      placeholder="E.g., recent travel history, specific allergies, medications you're taking, any concerns about donating, or other relevant health information..."
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 resize-none"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-2">
                      <i data-lucide="info" class="size-3 inline mr-1"></i>
                      This information will be shared with medical professionals
                      during your donation
                    </p>
                  </div>
                </div>

                <div class="pt-6">
                  <button
                    type="submit"
                    class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium"
                  >
                    <i data-lucide="save" class="size-4 inline mr-2"></i>Save
                    Changes
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Side Info -->
          <div class="space-y-6">
            <div class="p-6 bg-white border border-gray-200 rounded-xl">
              <h3 class="font-semibold text-gray-900 mb-4">
                Why is this important?
              </h3>
              <ul class="space-y-3 text-sm text-gray-600">
                <li class="flex items-start gap-2">
                  <i
                    data-lucide="alert-circle"
                    class="size-5 text-red-600 shrink-0 mt-0.5"
                  ></i>
                  <span>Accurate health info ensures safe donations</span>
                </li>
                <li class="flex items-start gap-2">
                  <i
                    data-lucide="alert-circle"
                    class="size-5 text-red-600 shrink-0 mt-0.5"
                  ></i>
                  <span>Protects both you and the recipient</span>
                </li>
                <li class="flex items-start gap-2">
                  <i
                    data-lucide="alert-circle"
                    class="size-5 text-red-600 shrink-0 mt-0.5"
                  ></i>
                  <span>Helps medical staff provide better care</span>
                </li>
                <li class="flex items-start gap-2">
                  <i
                    data-lucide="alert-circle"
                    class="size-5 text-red-600 shrink-0 mt-0.5"
                  ></i>
                  <span>Required for regulatory compliance</span>
                </li>
              </ul>
            </div>

            <div
              class="p-6 bg-linear-to-br from-green-50 to-white border border-green-200 rounded-xl"
              id="statusCard"
            >
              <div class="flex items-center gap-3 mb-3">
                <i
                  data-lucide="check-circle"
                  class="size-6 text-green-600"
                  id="statusIcon"
                ></i>
                <h3 class="font-semibold text-gray-900">Your Status</h3>
              </div>
              <p class="text-sm text-gray-600 mb-3" id="statusDescription">
                Based on your current health information:
              </p>
              <span
                class="px-3 py-1 text-sm font-medium bg-green-100 text-green-700 rounded-full"
                id="statusBadge"
                >Loading...</span
              >
              <ul class="mt-3 space-y-1 hidden" id="eligibilityReasons"></ul>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module" src="/src/scripts/main.js"></script>
    <script type="module">
      import { initUserLoader } from "/src/scripts/user-loader.js";
      initUserLoader();

      // Account status check
      async function checkAccountStatus() {
        try {
          const response = await fetch("/api/auth/check.php");
          const data = await response.json();

          if (!data.success || !data.logged_in) {
            window.location.href = "/src/pages/auth/login.html";
            return false;
          }

          const status = data.user.status || "pending";
          const dashboardContent = document.getElementById("dashboardContent");
          const pendingMessage = document.getElementById(
            "pendingApprovalMessage",
          );

          // Handle rejected status - logout and redirect to login
          if (status === "rejected") {
            await fetch("/api/auth/logout.php", { method: "POST" });
            window.location.href = "/src/pages/auth/login.html?error=rejected";
            return false;
          }

          if (status !== "approved") {
            if (dashboardContent) dashboardContent.classList.add("hidden");
            if (pendingMessage) {
              pendingMessage.classList.remove("hidden");
              if (window.lucide) window.lucide.createIcons();
            }
            return false;
          }

          if (dashboardContent) dashboardContent.classList.remove("hidden");
          if (pendingMessage) pendingMessage.classList.add("hidden");
          return true;
        } catch (error) {
          console.error("Failed to check account status:", error);
          return false;
        }
      }

      // Initialize only if approved
      checkAccountStatus();
    </script>
    <script type="module">
      import { z } from "https://cdn.jsdelivr.net/npm/zod@3.22.4/+esm";

      // Track if health record exists (for flexible validation)
      let hasExistingHealthRecord = false;

      // Fetch health data from API
      async function loadHealthData() {
        try {
          const response = await fetch("/api/donor/health.php", {
            credentials: "include",
          });
          const data = await response.json();

          // Show the status banner
          const banner = document.getElementById("healthRecordBanner");
          const newRecordBanner = document.getElementById("newRecordBanner");
          const existingRecordBanner = document.getElementById(
            "existingRecordBanner",
          );
          banner.classList.remove("hidden");

          if (data.success) {
            // Check if there's existing health data
            const hasData = data.health.height || data.health.weight;
            hasExistingHealthRecord = hasData;

            if (hasData) {
              // Show existing record banner
              newRecordBanner.classList.add("hidden");
              existingRecordBanner.classList.remove("hidden");

              // Show last updated time if available
              const lastUpdatedText =
                document.getElementById("lastUpdatedText");
              if (data.health.updated_at) {
                const date = new Date(data.health.updated_at);
                lastUpdatedText.textContent = `Last updated: ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
              }

              // Update weight/height labels to show they're optional for updates
              updateLabelsForExistingRecord();
            } else {
              // Show new record banner
              newRecordBanner.classList.remove("hidden");
              existingRecordBanner.classList.add("hidden");
            }

            // Populate form fields
            if (data.health.weight) {
              document.getElementById("weight").value = data.health.weight;
            }
            if (data.health.height) {
              document.getElementById("height").value = data.health.height;
            }

            // Populate blood pressure fields
            if (data.health.blood_pressure_systolic) {
              document.getElementById("bpSystolic").value =
                data.health.blood_pressure_systolic;
            }
            if (data.health.blood_pressure_diastolic) {
              document.getElementById("bpDiastolic").value =
                data.health.blood_pressure_diastolic;
            }

            // Populate hemoglobin
            if (data.health.hemoglobin) {
              document.getElementById("hemoglobin").value =
                data.health.hemoglobin;
            }

            // Populate medical checkup date
            if (data.health.last_medical_checkup) {
              document.getElementById("lastCheckup").value =
                data.health.last_medical_checkup;
            }

            // Populate medical conditions (checkboxes) using IDs
            if (data.health.has_diabetes)
              document.getElementById("hasDiabetes").checked = true;
            if (data.health.has_hypertension)
              document.getElementById("hasHypertension").checked = true;
            if (data.health.has_heart_disease)
              document.getElementById("hasHeartDisease").checked = true;
            if (data.health.has_asthma)
              document.getElementById("hasAsthma").checked = true;
            if (data.health.has_allergies)
              document.getElementById("hasAllergies").checked = true;
            if (data.health.has_recent_surgery)
              document.getElementById("hasRecentSurgery").checked = true;
            if (data.health.is_on_medication)
              document.getElementById("isOnMedication").checked = true;

            // Populate lifestyle dropdowns using IDs
            if (data.health.smoking_status) {
              document.getElementById("smokingStatus").value =
                data.health.smoking_status;
            }
            if (data.health.alcohol_consumption) {
              document.getElementById("alcoholConsumption").value =
                data.health.alcohol_consumption;
            }
            if (data.health.exercise_frequency) {
              document.getElementById("exerciseFrequency").value =
                data.health.exercise_frequency;
            }

            // Populate notes
            if (data.health.additional_notes) {
              document.getElementById("additionalNotes").value =
                data.health.additional_notes;
            }

            // Update eligibility status
            updateEligibilityStatus(data.eligibility);
          } else {
            // No data - show new record banner
            newRecordBanner.classList.remove("hidden");
            existingRecordBanner.classList.add("hidden");
            showErrorState("Failed to load health information");
          }

          // Refresh icons
          if (window.lucide) window.lucide.createIcons();
        } catch (error) {
          console.error("Error loading health data:", error);
          showErrorState("Unable to connect to server");
        }
      }

      function updateLabelsForExistingRecord() {
        // Update the weight and height labels to indicate they're optional for updates
        const weightLabel = document.querySelector('label[for="weight"]');
        const heightLabel = document.querySelector('label[for="height"]');

        if (weightLabel) {
          weightLabel.innerHTML =
            'Weight (kg) <span class="text-gray-400 font-normal">(leave empty to keep current)</span>';
        }
        if (heightLabel) {
          heightLabel.innerHTML =
            'Height (cm) <span class="text-gray-400 font-normal">(leave empty to keep current)</span>';
        }
      }

      function updateEligibilityStatus(eligibility) {
        const statusCard = document.getElementById("statusCard");
        const statusIcon = document.getElementById("statusIcon");
        const statusBadge = document.getElementById("statusBadge");
        const eligibilityReasons =
          document.getElementById("eligibilityReasons");

        if (eligibility.is_eligible) {
          statusCard.setAttribute(
            "class",
            "p-6 bg-linear-to-br from-green-50 to-white border border-green-200 rounded-xl",
          );
          statusIcon.setAttribute("data-lucide", "check-circle");
          statusIcon.setAttribute("class", "size-6 text-green-600");
          statusBadge.textContent = "Eligible to Donate";
          statusBadge.setAttribute(
            "class",
            "px-3 py-1 text-sm font-medium bg-green-100 text-green-700 rounded-full",
          );
          eligibilityReasons.classList.add("hidden");
        } else {
          statusCard.setAttribute(
            "class",
            "p-6 bg-linear-to-br from-red-50 to-white border border-red-200 rounded-xl",
          );
          statusIcon.setAttribute("data-lucide", "alert-circle");
          statusIcon.setAttribute("class", "size-6 text-red-600");
          statusBadge.textContent = "Not Eligible";
          statusBadge.setAttribute(
            "class",
            "px-3 py-1 text-sm font-medium bg-red-100 text-red-700 rounded-full",
          );

          if (eligibility.reasons && eligibility.reasons.length > 0) {
            eligibilityReasons.innerHTML = eligibility.reasons
              .map(
                (reason) =>
                  `<li class="text-sm text-red-600 flex items-start gap-2">
              <i data-lucide="x-circle" class="size-4 shrink-0 mt-0.5"></i>
              <span>${reason}</span>
            </li>`,
              )
              .join("");
            eligibilityReasons.classList.remove("hidden");
          }
        }

        // Refresh icons
        if (window.lucide) {
          window.lucide.createIcons();
        }
      }

      function showErrorState(message) {
        const statusBadge = document.getElementById("statusBadge");
        statusBadge.textContent = message;
        statusBadge.className =
          "px-3 py-1 text-sm font-medium bg-gray-100 text-gray-700 rounded-full";
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", loadHealthData);

      // Schema for new records (weight/height required)
      const newRecordSchema = z.object({
        weight: z
          .string()
          .min(1, "Weight is required")
          .refine(
            (val) => !isNaN(Number(val)) && Number(val) >= 45,
            "Weight must be at least 45 kg",
          ),
        height: z
          .string()
          .min(1, "Height is required")
          .refine(
            (val) => !isNaN(Number(val)) && Number(val) >= 100,
            "Height must be at least 100 cm",
          ),
      });

      // Schema for updates (weight/height optional, but if provided must be valid)
      const updateRecordSchema = z.object({
        weight: z
          .string()
          .refine(
            (val) => val === "" || (!isNaN(Number(val)) && Number(val) >= 45),
            "Weight must be at least 45 kg",
          ),
        height: z
          .string()
          .refine(
            (val) => val === "" || (!isNaN(Number(val)) && Number(val) >= 100),
            "Height must be at least 100 cm",
          ),
      });

      function showError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorEl = document.getElementById(fieldId + "Error");
        if (field) {
          field.classList.add("border-red-500");
          field.classList.remove("border-gray-300");
        }
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.remove("hidden");
        }
      }

      function clearError(fieldId) {
        const field = document.getElementById(fieldId);
        const errorEl = document.getElementById(fieldId + "Error");
        if (field) {
          field.classList.remove("border-red-500");
          field.classList.add("border-gray-300");
        }
        if (errorEl) {
          errorEl.textContent = "";
          errorEl.classList.add("hidden");
        }
      }

      ["weight", "height"].forEach((id) => {
        const field = document.getElementById(id);
        if (field) field.addEventListener("input", () => clearError(id));
      });

      document
        .getElementById("healthForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          clearError("weight");
          clearError("height");

          const formData = {
            weight: document.getElementById("weight").value,
            height: document.getElementById("height").value,
          };

          // Use appropriate schema based on whether record exists
          const schema = hasExistingHealthRecord
            ? updateRecordSchema
            : newRecordSchema;
          const result = schema.safeParse(formData);

          if (!result.success) {
            result.error.errors.forEach((err) =>
              showError(err.path[0], err.message),
            );
            return;
          }

          // Collect all form data for API using IDs
          const healthData = {
            weight: formData.weight ? parseFloat(formData.weight) : null,
            height: formData.height ? parseFloat(formData.height) : null,
            blood_pressure_systolic: document.getElementById("bpSystolic").value
              ? parseInt(document.getElementById("bpSystolic").value)
              : null,
            blood_pressure_diastolic: document.getElementById("bpDiastolic")
              .value
              ? parseInt(document.getElementById("bpDiastolic").value)
              : null,
            hemoglobin: document.getElementById("hemoglobin").value
              ? parseFloat(document.getElementById("hemoglobin").value)
              : null,
            last_medical_checkup:
              document.getElementById("lastCheckup").value || null,
            has_diabetes: document.getElementById("hasDiabetes").checked,
            has_hypertension:
              document.getElementById("hasHypertension").checked,
            has_heart_disease:
              document.getElementById("hasHeartDisease").checked,
            has_asthma: document.getElementById("hasAsthma").checked,
            has_allergies: document.getElementById("hasAllergies").checked,
            has_recent_surgery:
              document.getElementById("hasRecentSurgery").checked,
            is_on_medication: document.getElementById("isOnMedication").checked,
            smoking_status: document.getElementById("smokingStatus").value,
            alcohol_consumption:
              document.getElementById("alcoholConsumption").value,
            exercise_frequency:
              document.getElementById("exerciseFrequency").value,
            additional_notes:
              document.getElementById("additionalNotes").value || null,
          };

          // Remove null values for partial updates (backend will preserve existing)
          if (hasExistingHealthRecord) {
            Object.keys(healthData).forEach((key) => {
              if (healthData[key] === null || healthData[key] === "") {
                delete healthData[key];
              }
            });
          }

          try {
            const response = await fetch("/api/donor/health/update.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(healthData),
            });

            const data = await response.json();

            if (data.success) {
              const isUpdate = data.is_update || hasExistingHealthRecord;
              const notification = document.createElement("div");
              notification.className =
                "fixed top-20 right-8 p-4 bg-green-50 border-l-4 border-green-600 rounded-lg shadow-lg z-50";
              notification.innerHTML = `
                <div class="flex items-center gap-3">
                  <i data-lucide="check-circle" class="size-5 text-green-600"></i>
                  <p class="text-green-900">${isUpdate ? "Health information updated successfully!" : "Health information saved successfully!"}</p>
                </div>`;
              document.body.appendChild(notification);
              lucide.createIcons();
              setTimeout(() => notification.remove(), 3000);

              // Reload data to update eligibility status and banners
              loadHealthData();
            } else {
              throw new Error(data.message || "Failed to save");
            }
          } catch (error) {
            console.error("Save error:", error);
            const notification = document.createElement("div");
            notification.className =
              "fixed top-20 right-8 p-4 bg-red-50 border-l-4 border-red-600 rounded-lg shadow-lg z-50";
            notification.innerHTML =
              '<div class="flex items-center gap-3"><i data-lucide="x-circle" class="size-5 text-red-600"></i><p class="text-red-900">Failed to save health information. Please try again.</p></div>';
            document.body.appendChild(notification);
            lucide.createIcons();
            setTimeout(() => notification.remove(), 3000);
          }
        });
    </script>
  </body>
</html>
